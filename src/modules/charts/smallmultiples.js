"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),SmallMultiples=function(){function t(e,r){(0,_classCallCheck2.default)(this,t);var a=this,i=e.sheets.data,n=e.sheets.template,o=(0,_toConsumableArray2.default)(new Set(i.map(function(t){return t.State}))),s=""!=n[0].tooltip;i.forEach(function(t){if("string"==typeof t.Cases&&(t.Cases=+t.Cases),"string"==typeof t.Date){var e=d3.timeParse("%Y-%m-%d");t.Date=e(t.Date)}}),s&&(this.tooltip=d3.select("body").append("div").attr("class","tooltip").attr("id","tooltip").style("position","absolute").style("background-color","white").style("opacity",0)),this.utilities={decimals:function(t){var e=t.split(",");return parseFloat(this[e[0]]).toFixed(e[1])},nicedate:function(t){var e=this[t];return(0,_moment.default)(e).format("MMM D")}},this.data=i,this.keys=o,this.details=n,this.isMobile=r,this.hasTooltip=s,this.template=n[0].tooltip,this.showGroupMax=!0,d3.select("#switch").on("click",function(){a.showGroupMax=!a.showGroupMax;var t=a.showGroupMax?"Show max scale for each chart":"Show max scale for group";d3.select(this).html(t)}),this.render()}return(0,_createClass2.default)(t,[{key:"render",value:function(){var t=this;d3.select("#graphicContainer").selectAll("svg").remove(),d3.select("#graphicContainer").html("");for(var e=0;e<this.keys.length;e++)this._drawSmallChart(t.data,e,t.keys,t.details,t.isMobile,t.hasTooltip)}},{key:"_drawSmallChart",value:function(t,e,r,a,i,n){function o(){C=l.showGroupMax?t:t.filter(function(t){return t.State===r[e]}),y.domain(d3.extent(C,function(t){return t.Cases}));var a=g.selectAll(".bar").data(t.filter(function(t){return t.State===r[e]}));a.enter().append("rect").attr("class","bar").style("fill",function(){return"rgb(204, 10, 17)"}).attr("height",0).attr("y",h).merge(a).transition().duration(v).attr("x",function(t){return b(t.Date)}).attr("y",function(t){return y(Math.max(t.Cases,0))}).attr("width",b.bandwidth()).attr("height",function(t){return Math.abs(y(t.Cases)-y(0))}),a.exit().transition().duration(v).attr("height",0).attr("y",h).remove(),g.select(".y").transition().duration(v).call(M)}var s,l=this,u=document.querySelector("#graphicContainer").getBoundingClientRect().width;s=u<500?1:u<750?2:3;var c,d=document.querySelector("#graphicContainer").getBoundingClientRect().width/s,h=.5*d;c=a[0]["margin-top"]?{top:+a[0]["margin-top"],right:+a[0]["margin-right"],bottom:+a[0]["margin-bottom"],left:+a[0]["margin-left"]}:{top:0,right:0,bottom:20,left:50},d=d-c.left-c.right,h=h-c.top-c.bottom,d3.select("#graphicContainer").append("div").attr("id",r[e]).attr("class","barGrid");var p="#",f=p.concat(r[e]);d3.select(f).append("div").text(r[e]).attr("class","chartSubTitle");var m=d3.select(f).append("svg").attr("width",d+c.left+c.right).attr("height",h+c.top+c.bottom).attr("overflow","hidden"),g=m.append("g").attr("transform","translate("+c.left+","+c.top+")"),b=(Object.keys(t[0]),d3.scaleBand().range([0,d]).paddingInner(.08)),y=d3.scaleLinear().range([h,0]),v=1e3,C=this.showGroupMax?t:t.filter(function(t){return t.State===r[e]});b.domain(t.map(function(t){return t.Date})),y.domain(d3.extent(C,function(t){return t.Cases})).nice();var w=Math.round(b.domain().length/3),x=b.domain().filter(function(t,e){return!(e%w)||e===b.domain().length-1}),_=d3.axisBottom(b).tickValues(x).tickFormat(d3.timeFormat("%d %b")),M=d3.axisLeft(y).tickFormat(function(t){return t}).ticks(5);g.append("g").attr("class","x").attr("transform","translate(0,"+h+")").call(_),g.append("g").attr("class","y"),document.getElementById("switch").addEventListener("click",function(){return o()}),o()}},{key:"mustache",value:function(t,e,r,a){function i(t,e){return e=e.pop?e:e.split("."),t=t[e.shift()],t=null!=t?t:"",0 in e?i(t,e):t}var n,o=this.mustache,s="";e=Array.isArray(e)?e:e?[e]:[],e=a?0 in e?[]:[1]:e;for(n=0;n<e.length;n++){var l,u="",c=0,d="object"==(0,_typeof2.default)(e[n])?e[n]:{};d=Object.assign({},r,d),d[""]={"":e[n]},t.replace(/([\s\S]*?)({{((\/)|(\^)|#)(.*?)}}|$)/g,function(t,e,r,a,n,h,p){c?u+=c&&!n||c>1?t:e:(s+=e.replace(/{{{(.*?)}}}|{{(!?)(&?)(>?)(.*?)}}/g,function(t,e,r,a,n,s){return e?i(d,e):a?i(d,s):n?o(i(d,s),d):r?"":new Option(i(d,s)).innerHTML}),l=h),n?--c||(p=i(d,p),/^f/.test((0,_typeof2.default)(p))?s+=p.call(d,u,function(t){return o(t,d)}):s+=o(u,p,d,l),u=""):++c})}return s}}]),t}();exports.default=SmallMultiples;