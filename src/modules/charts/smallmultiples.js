"use strict";function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,a)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){(0,_defineProperty2.default)(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),_mustache=_interopRequireDefault(require("../utilities/mustache")),_helpers=_interopRequireDefault(require("../utilities/helpers")),SmallMultiples=function(){function t(e){(0,_classCallCheck2.default)(this,t);var r=this,a=e.sheets.data,i=e.sheets.template,n=(0,_toConsumableArray2.default)(new Set(a.map(function(t){return t.State}))),o=""!=i[0].tooltip,l=Math.max(document.documentElement.clientWidth,window.innerWidth||0);a.forEach(function(t){if("string"==typeof t.Cases&&(t.Cases=+t.Cases),"string"==typeof t.Date){var e=d3.timeParse("%Y-%m-%d");t.Date=e(t.Date)}}),o&&(this.tooltip=d3.select("body").append("div").attr("class","tooltip").attr("id","tooltip").style("position","absolute").style("background-color","white").style("opacity",0)),this.data=a,this.keys=n,this.details=i,this.isMobile=l<610,this.hasTooltip=o,this.template=i[0].tooltip,this.showGroupMax=!0,d3.select("#switch").on("click",function(){r.showGroupMax=!r.showGroupMax;var t=r.showGroupMax?"Show max scale for each chart":"Show max scale for group";d3.select(this).html(t)}),this.render()}return(0,_createClass2.default)(t,[{key:"render",value:function(){var t=this;d3.select("#graphicContainer").selectAll("svg").remove(),d3.select("#graphicContainer").html("");for(var e=0;e<this.keys.length;e++)this._drawSmallChart(t.data,e,t.keys,t.details,t.isMobile,t.hasTooltip)}},{key:"_drawSmallChart",value:function(t,e,r,a,i,n){function o(){w=s.showGroupMax?t:t.filter(function(t){return t.State===r[e]}),b.domain(d3.extent(w,function(t){return t.Cases}));var a=g.selectAll(".bar").data(t.filter(function(t){return t.State===r[e]}));a.enter().append("rect").attr("class","bar").style("fill",function(){return"rgb(204, 10, 17)"}).attr("height",0).attr("y",d).merge(a).transition().duration(v).attr("x",function(t){return y(t.Date)}).attr("y",function(t){return b(Math.max(t.Cases,0))}).attr("width",y.bandwidth()).attr("height",function(t){return Math.abs(b(t.Cases)-b(0))}),d3.selectAll(".bar").on("mouseover",function(t){if(n){var e=(0,_mustache.default)(s.template,_objectSpread({},_helpers.default,{},t));s.tooltip.html(e);var r=document.querySelector("#tooltip").getBoundingClientRect().width;d3.event.pageX<p/2?s.tooltip.style("left",d3.event.pageX+r/2+"px"):d3.event.pageX>=p/2&&s.tooltip.style("left",d3.event.pageX-r+"px"),s.tooltip.style("top",d3.event.pageY+"px"),s.tooltip.transition().duration(200).style("opacity",.9)}}).on("mouseout",function(){n&&s.tooltip.transition().duration(500).style("opacity",0)}),a.exit().transition().duration(v).attr("height",0).attr("y",d).remove(),g.select(".y").transition().duration(v).call(q)}var l,s=this,u=document.querySelector("#graphicContainer").getBoundingClientRect().width;l=u<500?1:u<750?2:3;var c,p=document.querySelector("#graphicContainer").getBoundingClientRect().width/l,d=.5*p;c=a[0]["margin-top"]?{top:+a[0]["margin-top"],right:+a[0]["margin-right"],bottom:+a[0]["margin-bottom"],left:+a[0]["margin-left"]}:{top:0,right:0,bottom:20,left:50},p=p-c.left-c.right,d=d-c.top-c.bottom,d3.select("#graphicContainer").append("div").attr("id",r[e]).attr("class","barGrid");var h="#",f=h.concat(r[e]);d3.select(f).append("div").text(r[e]).attr("class","chartSubTitle");var m=d3.select(f).append("svg").attr("width",p+c.left+c.right).attr("height",d+c.top+c.bottom).attr("overflow","hidden"),g=m.append("g").attr("transform","translate("+c.left+","+c.top+")"),y=(Object.keys(t[0]),d3.scaleBand().range([0,p]).paddingInner(.08)),b=d3.scaleLinear().range([d,0]),v=1e3,w=this.showGroupMax?t:t.filter(function(t){return t.State===r[e]});y.domain(t.map(function(t){return t.Date})),b.domain(d3.extent(w,function(t){return t.Cases})).nice();var C=Math.round(y.domain().length/3),_=y.domain().filter(function(t,e){return!(e%C)||e===y.domain().length-1}),x=d3.axisBottom(y).tickValues(_).tickFormat(d3.timeFormat("%d %b")),q=d3.axisLeft(b).tickFormat(function(t){return t}).ticks(5);g.append("g").attr("class","x").attr("transform","translate(0,"+d+")").call(x),g.append("g").attr("class","y"),document.getElementById("switch").addEventListener("click",function(){return o()}),o()}}]),t}();exports.default=SmallMultiples;