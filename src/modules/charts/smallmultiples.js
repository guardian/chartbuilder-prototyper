"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),SmallMultiples=function(){function t(e,r){(0,_classCallCheck2.default)(this,t);var a=this,i=e.sheets.data,n=e.sheets.template,o=(0,_toConsumableArray2.default)(new Set(i.map(function(t){return t.State}))),s=""!=n[0].tooltip;i.forEach(function(t){if("string"==typeof t.Cases&&(t.Cases=+t.Cases),"string"==typeof t.Date){var e=d3.timeParse("%Y-%m-%d");t.Date=e(t.Date)}}),s&&(this.tooltip=d3.select("body").append("div").attr("class","tooltip").attr("id","tooltip").style("position","absolute").style("background-color","white").style("opacity",0)),this.utilities={decimals:function(t){var e=t.split(",");return parseFloat(this[e[0]]).toFixed(e[1])},nicedate:function(t){var e=this[t];return(0,_moment.default)(e).format("MMM D")}},this.data=i,this.keys=o,this.details=n,this.isMobile=r,this.hasTooltip=s,this.template=n[0].tooltip,this.showGroupMax=!0,d3.select("#switch").on("click",function(){a.showGroupMax=!a.showGroupMax;var t=a.showGroupMax?"Show max scale for each chart":"Show max scale for group";d3.select(this).html(t),a.render()}),this.render()}return(0,_createClass2.default)(t,[{key:"render",value:function(){var t=this;d3.select("#graphicContainer").selectAll("svg").remove(),d3.select("#graphicContainer").html("");for(var e=0;e<this.keys.length;e++)this._drawSmallChart(t.data,e,t.keys,t.details,t.isMobile,t.hasTooltip)}},{key:"_drawSmallChart",value:function(t,e,r,a,i,n){function o(){x=u.showGroupMax?t:t.filter(function(t){return t.State===r[e]}),v.domain(d3.extent(x,function(t){return t.Cases}));var a=b.selectAll(".bar").data(t.filter(function(t){return t.State===r[e]}));a.enter().append("rect").attr("class","bar").style("fill",function(){return"rgb(204, 10, 17)"}).attr("height",0).attr("y",p).merge(a).transition().duration(C).attr("x",function(t){return y(t.Date)}).attr("y",function(t){return v(Math.max(t.Cases,0))}).attr("width",y.bandwidth()).attr("height",function(t){return Math.abs(v(t.Cases)-v(0))}),a.exit().transition().duration(C).attr("height",0).attr("y",p).remove(),b.select(".y").transition().duration(C).call(k)}function s(){u.showGroupMax=!!u.showGroupMax,o()}var l,u=this,c=document.querySelector("#graphicContainer").getBoundingClientRect().width;l=c<500?1:c<750?2:3;var h,d=document.querySelector("#graphicContainer").getBoundingClientRect().width/l,p=.5*d;h=a[0]["margin-top"]?{top:+a[0]["margin-top"],right:+a[0]["margin-right"],bottom:+a[0]["margin-bottom"],left:+a[0]["margin-left"]}:{top:0,right:0,bottom:20,left:50},d=d-h.left-h.right,p=p-h.top-h.bottom,d3.select("#graphicContainer").append("div").attr("id",r[e]).attr("class","barGrid");var f="#",m=f.concat(r[e]);d3.select(m).append("div").text(r[e]).attr("class","chartSubTitle");var g=d3.select(m).append("svg").attr("width",d+h.left+h.right).attr("height",p+h.top+h.bottom).attr("overflow","hidden"),b=g.append("g").attr("transform","translate("+h.left+","+h.top+")"),y=(Object.keys(t[0]),d3.scaleBand().range([0,d]).paddingInner(.08)),v=d3.scaleLinear().range([p,0]),C=1e3,x=this.showGroupMax?t:t.filter(function(t){return t.State===r[e]});y.domain(t.map(function(t){return t.Date})),v.domain(d3.extent(x,function(t){return t.Cases})).nice();var w=Math.round(y.domain().length/3),_=y.domain().filter(function(t,e){return!(e%w)||e===y.domain().length-1}),M=d3.axisBottom(y).tickValues(_).tickFormat(d3.timeFormat("%d %b")),k=d3.axisLeft(v).tickFormat(function(t){return t}).ticks(5);b.append("g").attr("class","x").attr("transform","translate(0,"+p+")").call(M),b.append("g").attr("class","y").call(k),s.bind(this)()}},{key:"mustache",value:function(t,e,r,a){function i(t,e){return e=e.pop?e:e.split("."),t=t[e.shift()],t=null!=t?t:"",0 in e?i(t,e):t}var n,o=this.mustache,s="";e=Array.isArray(e)?e:e?[e]:[],e=a?0 in e?[]:[1]:e;for(n=0;n<e.length;n++){var l,u="",c=0,h="object"==(0,_typeof2.default)(e[n])?e[n]:{};h=Object.assign({},r,h),h[""]={"":e[n]},t.replace(/([\s\S]*?)({{((\/)|(\^)|#)(.*?)}}|$)/g,function(t,e,r,a,n,d,p){c?u+=c&&!n||c>1?t:e:(s+=e.replace(/{{{(.*?)}}}|{{(!?)(&?)(>?)(.*?)}}/g,function(t,e,r,a,n,s){return e?i(h,e):a?i(h,s):n?o(i(h,s),h):r?"":new Option(i(h,s)).innerHTML}),l=d),n?--c||(p=i(h,p),/^f/.test((0,_typeof2.default)(p))?s+=p.call(h,u,function(t){return o(t,h)}):s+=o(u,p,h,l),u=""):++c})}return s}}]),t}();exports.default=SmallMultiples;