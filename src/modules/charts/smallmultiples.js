"use strict";function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){(0,_defineProperty2.default)(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),_mustache=_interopRequireDefault(require("../utilities/mustache")),_helpers=_interopRequireDefault(require("../utilities/helpers")),_tooltip=_interopRequireDefault(require("./shared/tooltip")),SmallMultiples=function(){function t(e){var r=this;(0,_classCallCheck2.default)(this,t),console.log(e);var i=this,a=e.sheets.data,n=e.sheets.template,o=e.sheets.options,l=Object.keys(a[0]);console.log(l),this.groupVar=l[1],this.xVar=l[0],this.yVar=l[2],this.hasTooltip=""!=n[0].tooltip;var s=(0,_toConsumableArray2.default)(new Set(a.map(function(t){return t[r.groupVar]}))),u=Math.max(document.documentElement.clientWidth,window.innerWidth||0);a.forEach(function(t){if("string"==typeof t[i.yVar]&&(t[i.yVar]=+t[i.yVar]),"string"==typeof t[i.xVar]){var e=d3.timeParse("%Y-%m-%d");t[i.xVar]=e(t[i.xVar])}}),this.hasTooltip&&(this.tooltip=new _tooltip.default("#graphicContainer")),this.data=a,this.keys=s,this.details=n,this.isMobile=u<610,this.template=n[0].tooltip,"group"==o[0].scaleBy?this.showGroupMax=!0:(this.showGroupMax=!1,d3.select("#switch").html("Show max scale for group")),d3.select("#switch").on("click",function(){i.showGroupMax=!i.showGroupMax;var t=i.showGroupMax?"Show max scale for each chart":"Show max scale for group";d3.select(this).html(t)});var c;c=n[0]["margin-top"]?{top:+n[0]["margin-top"],right:+n[0]["margin-right"],bottom:+n[0]["margin-bottom"],left:+n[0]["margin-left"]}:{top:0,right:0,bottom:20,left:50},this.margin=c,this.width,this.height,this.render()}return(0,_createClass2.default)(t,[{key:"render",value:function(){var t=this,e=document.querySelector("#graphicContainer").getBoundingClientRect().width;t.containerHeight=document.querySelector("#graphicContainer").getBoundingClientRect().width,console.log("containerWidth",e);var r;r=e<=500?1:e<=750?2:3,console.log(r);var i=document.querySelector("#graphicContainer").getBoundingClientRect().width/r;console.log("width",i);var a=200;t.isMobile&&(a=150),t.width=i-t.margin.left-t.margin.right,t.height=a-t.margin.top-t.margin.bottom,d3.select("#graphicContainer").selectAll(".barGrid").remove();for(var n=0;n<this.keys.length;n++)this._drawSmallChart(t.data,n,t.keys,t.details,t.isMobile,t.hasTooltip)}},{key:"_drawSmallChart",value:function(t,e,r,i,a,n){function o(t){return t.replace(/ /g,"_")}function l(t){if(t>0)return t>1e9?t/1e9+"bn":t>1e6?t/1e6+"m":t>1e3?t/1e3+"k":t%1!=0?t.toFixed(2):t.toLocaleString();if(t<0){var e=-1*t;return e>1e9?["-"+String(e/1e9)+"bn"]:e>1e6?["-"+String(e/1e6)+"m"]:e>1e3?["-"+String(e/1e3)+"k"]:t.toLocaleString()}return t}function s(){b=u.showGroupMax?t:t.filter(function(t){return t[u.groupVar]===r[e]}),f.domain(d3.extent(b,function(t){return t[u.yVar]}));var i=p.selectAll(".bar").data(t.filter(function(t){return t[u.groupVar]===r[e]}));if(i.enter().append("rect").attr("class","bar").style("fill",function(){return"rgb(204, 10, 17)"}).attr("height",0).attr("y",u.height).merge(i).transition().duration(m).attr("x",function(t){return g(t[u.xVar])}).attr("y",function(t){return f(Math.max(t[u.yVar],0))}).attr("width",g.bandwidth()).attr("height",function(t){return Math.abs(f(t[u.yVar])-f(0))}),n){var a=function(t){return(0,_mustache.default)(u.template,_objectSpread({},_helpers.default,{},t))};u.tooltip.bindEvents(d3.selectAll(".bar"),u.width,u.containerHeight,a)}i.exit().transition().duration(m).attr("height",0).attr("y",u.height).remove(),p.select(".y").transition().duration(m).call(_)}var u=this;d3.select("#graphicContainer").append("div").attr("id",o(r[e])).attr("class","barGrid");var c="#",h=c.concat(o(r[e]));d3.select(h).append("div").text(r[e]).attr("class","chartSubTitle");var d=d3.select(h).append("svg").attr("width",u.width+u.margin.left+u.margin.right).attr("height",u.height+u.margin.top+u.margin.bottom).attr("overflow","hidden"),p=d.append("g").attr("transform","translate("+u.margin.left+","+u.margin.top+")"),g=(Object.keys(t[0]),d3.scaleBand().range([0,u.width]).padding(0)),f=d3.scaleLinear().range([u.height,0]),m=1e3,b=u.showGroupMax?t:t.filter(function(t){return t[u.groupVar]===r[e]});g.domain(t.map(function(t){return t[u.xVar]})),f.domain(d3.extent(b,function(t){return t[u.yVar]})).nice();var y=Math.round(g.domain().length/3),w=g.domain().filter(function(t,e){return!(e%y)||e===g.domain().length-1}),v=d3.axisBottom(g).tickValues(w).tickFormat(d3.timeFormat("%d %b")),_=d3.axisLeft(f).tickFormat(function(t){return l(t)}).ticks(3);p.append("g").attr("class","x").attr("transform","translate(0,"+u.height+")").call(v),p.append("g").attr("class","y"),document.getElementById("switch").addEventListener("click",function(){return s()}),s()}}]),t}();exports.default=SmallMultiples;