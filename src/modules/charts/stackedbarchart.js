"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),StackedBarChart=function t(e){function n(t){if(t>0)return t>1e9?t/1e9+"bn":t>1e6?t/1e6+"m":t>1e3?t/1e3+"k":t%1!=0?t.toFixed(2):t.toLocaleString();if(t<0){var e=-1*t;return e>1e9?["-"+String(e/1e9)+"bn"]:e>1e6?["-"+String(e/1e6)+"m"]:e>1e3?["-"+String(e/1e3)+"k"]:t.toLocaleString()}return t}function a(t){return d3.min(t,function(t){return t[0]})}function r(t){return d3.max(t,function(t){return t[1]})}function o(t){return t.y2>0?12:-2}function i(t){return t.y2>0?12:4}(0,_classCallCheck2.default)(this,t),console.log(e);var l=e.sheets.data,c=e.sheets.template,s=e.sheets.labels,u=e.sheets.key,d=[],f=[],p=null;u.length>1&&u.forEach(function(t){d.push(t.key),f.push(t.colour)});var g,h=Math.max(document.documentElement.clientWidth,window.innerWidth||0);h<610&&(g=!0),h>=610&&(g=!1);var m,y=document.querySelector("#graphicContainer").getBoundingClientRect().width,x=.5*y,k=null,b=null,v=null;m=""!=c[0]["margin-top"]?{top:+c[0]["margin-top"],right:+c[0]["margin-right"],bottom:+c[0]["margin-bottom"],left:+c[0]["margin-left"]}:{top:20,right:20,bottom:20,left:40},console.log(m),void 0!=(0,_typeof2.default)(c[0].dateFormat)&&(k=d3.timeParse(c[0].dateFormat)),void 0!=(0,_typeof2.default)(c[0].timeInterval)&&(b=c[0].timeInterval),void 0!=(0,_typeof2.default)(c[0].xAxisDateFormat)&&(v=d3.timeFormat(c[0].xAxisDateFormat)),""!=c[0].tooltip&&(p=!0),y=y-m.left-m.right,x=x-m.top-m.bottom,d3.select("#graphicContainer svg").remove();var C=d3.select("#chartKey");C.html("");var F=d3.select("#graphicContainer").append("svg").attr("width",y+m.left+m.right).attr("height",x+m.top+m.bottom).attr("id","svg").attr("overflow","hidden"),w=F.append("g").attr("transform","translate("+m.left+","+m.top+")"),_=Object.keys(l[0]),D=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00"],A=d3.scaleOrdinal();u.length>1?A.domain(d).range(f):A.domain(_).range(D);var E;c[0].xColumn?(E=c[0].xColumn,_.splice(_.indexOf(E),1)):(E=_[0],_.splice(0,1)),console.log(E,_),_.forEach(function(t,e){var n=C.append("div").attr("class","keyDiv");n.append("span").attr("class","keyCircle").style("background-color",function(){return A(t)}),n.append("span").attr("class","keyText").text(t)}),l.forEach(function(t){null!=k&&"string"==typeof t[E]&&(t[E]=k(t[E])),_.forEach(function(e,n){t[e]=+t[e]}),t.Total=d3.sum(_,function(e){return+t[e]})}),console.log(l),s.forEach(function(t){null!=k&&(t.x1=k(t.x1)),t.y1=+t.y1,t.y2=+t.y2});var M;b?(console.log(l[l.length-1][E]),"year"==b&&(M=d3.timeYear.range(l[0][E],d3.timeYear.offset(l[l.length-1][E],1))),"day"==b&&(M=d3.timeDay.range(l[0][E],d3.timeDay.offset(l[l.length-1][E],1))),"month"==b&&(M=d3.timeMonth.range(l[0][E],d3.timeMonth.offset(l[l.length-1][E],1)))):M=l.map(function(t){return t[E]});var T=d3.scaleBand().range([0,y]).paddingInner(.08);T.domain(M);var q=d3.scaleLinear().range([x,0]),S=d3.stack().offset(d3.stackOffsetDiverging).keys(_)(l);console.log(S),S.forEach(function(t){console.log(t.key),t.forEach(function(e){e.group=t.key})}),q.domain([d3.min(S,a),d3.max(S,r)]).nice();var L,B,O=3;console.log(T.domain().length);var R=Math.round(T.domain().length/10);g&&(R=Math.round(T.domain().length/5)),console.log("tickMod",R);var O=T.domain().filter(function(t,e){return!(e%R)});console.log(O),g?(L=d3.axisBottom(T).tickValues(O).tickFormat(v),B=d3.axisLeft(q).tickFormat(function(t){return n(t)}).ticks(5)):(L=d3.axisBottom(T).tickValues(O).tickFormat(v),B=d3.axisLeft(q).tickFormat(function(t){return n(t)})),w.append("g").attr("class","x").attr("transform","translate(0,"+x+")").call(L),w.append("g").attr("class","y").call(B),w.selectAll("layer").data(S,function(t){return t.key}).enter().append("g").attr("class",function(t){return"layer "+t.key}).style("fill",function(t,e){return A(t.key)}).selectAll("rect").data(function(t){return t}).enter().append("rect").attr("x",function(t){return T(t.data[E])}).attr("y",function(t){return q(t[1])}).attr("class","barPart").attr("title",function(t){return t.data[t.key]}).attr("data-group",function(t){return t.group}).attr("data-count",function(t){return t.data[t.key]}).attr("height",function(t){return q(t[0])-q(t[1])}).attr("width",T.bandwidth()),w.append("g").attr("class","x").attr("transform","translate(0,"+x+")").call(L),w.append("g").attr("class","y").call(B),p&&makeTooltip(".barPart",v),w.selectAll(".annotationLine").data(s).enter().append("line").attr("class","annotationLine").attr("x1",function(t){return T(t.x1)+T.bandwidth()/2}).attr("y1",function(t){return q(t.y1)}).attr("x2",function(t){return T(t.x1)+T.bandwidth()/2}).attr("y2",function(t){return q(t.y2)}).style("opacity",1).attr("stroke","#000");var P=d3.select("#footerAnnotations");P.html(""),g?(w.selectAll(".annotationCircles").data(s).enter().append("circle").attr("class","annotationCircle").attr("cy",function(t){return q(t.y2)+o(t)/2}).attr("cx",function(t){return T(t.x1)+T.bandwidth()/2}).attr("r",8).attr("fill","#000"),w.selectAll(".annotationTextMobile").data(s).enter().append("text").attr("class","annotationTextMobile").attr("y",function(t){return q(t.y2)+i(t)}).attr("x",function(t){return T(t.x1)+T.bandwidth()/2}).style("text-anchor","middle").style("opacity",1).attr("fill","#FFF").text(function(t,e){return e+1}),console.log(s.length),s.length>0&&P.append("span").attr("class","annotationFooterHeader").text("Notes: "),s.forEach(function(t,e){P.append("span").attr("class","annotationFooterNumber").text(e+1+" - "),e<s.length-1?P.append("span").attr("class","annotationFooterText").text(t.text+", "):P.append("span").attr("class","annotationFooterText").text(t.text)})):w.selectAll(".annotationText").data(s).enter().append("text").attr("class","annotationText").attr("y",function(t){return q(t.y2)-4}).attr("x",function(t){return T(t.x1)+T.bandwidth()/2}).style("text-anchor",function(t){return t.align}).style("opacity",1).text(function(t){return t.text})};exports.default=StackedBarChart;