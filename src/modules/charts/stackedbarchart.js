"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),StackedBarChart=function(){function t(e){function n(t){if(t>0)return t>1e9?t/1e9+"bn":t>1e6?t/1e6+"m":t>1e3?t/1e3+"k":t%1!=0?t.toFixed(2):t.toLocaleString();if(t<0){var e=-1*t;return e>1e9?["-"+String(e/1e9)+"bn"]:e>1e6?["-"+String(e/1e6)+"m"]:e>1e3?["-"+String(e/1e3)+"k"]:t.toLocaleString()}return t}function a(t){return d3.min(t,function(t){return t[0]})}function r(t){return d3.max(t,function(t){return t[1]})}function o(t){return t.y2>0?12:-2}function i(t){return t.y2>0?12:4}(0,_classCallCheck2.default)(this,t),console.log(e);var l=e.sheets.data,c=e.sheets.template,s=e.sheets.labels,u=e.sheets.key,d=[],f=[],p=null;u.length>1&&u.forEach(function(t){d.push(t.key),f.push(t.colour)}),console.log(c);var h,m=Math.max(document.documentElement.clientWidth,window.innerWidth||0);m<610&&(h=!0),m>=610&&(h=!1);var g,y=document.querySelector("#graphicContainer").getBoundingClientRect().width,x=.5*y,b=null,k=null;g=""!=c[0]["margin-top"]?{top:+c[0]["margin-top"],right:+c[0]["margin-right"],bottom:+c[0]["margin-bottom"],left:+c[0]["margin-left"]}:{top:20,right:20,bottom:20,left:40},void 0!=(0,_typeof2.default)(c[0].dateFormat)&&(b=d3.timeParse(c[0].dateFormat)),void 0!=(0,_typeof2.default)(c[0].timeInterval)&&(k=c[0].timeInterval),""!=c[0].tooltip&&(p=!0),y=y-g.left-g.right,x=x-g.top-g.bottom,d3.select("#chartTitle").text(c[0].title),d3.select("#subTitle").text(c[0].subtitle),d3.select("#sourceText").html(c[0].source),d3.select("#footnote").html(c[0].footnote),d3.select("#graphicContainer svg").remove();var v=d3.select("#chartKey");v.html("");var C=d3.select("#graphicContainer").append("svg").attr("width",y+g.left+g.right).attr("height",x+g.top+g.bottom).attr("id","svg").attr("overflow","hidden"),F=C.append("g").attr("transform","translate("+g.left+","+g.top+")"),w=Object.keys(l[0]),_=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00"],q=d3.scaleOrdinal();u.length>1?q.domain(d).range(f):q.domain(w).range(_);var T;c[0].xColumn?(T=c[0].xColumn,w.splice(w.indexOf(T),1)):(T=w[0],w.splice(0,1)),w.forEach(function(t){var e=v.append("div").attr("class","keyDiv");e.append("span").attr("class","keyCircle").style("background-color",function(){return q(t)}),e.append("span").attr("class","keyText").text(t)}),l.forEach(function(t){null!=b&&(t[T]=b(t[T])),w.forEach(function(e){t[e]=+t[e]})}),s.forEach(function(t){null!=b&&(t.x=b(t.x)),t.y=+t.y,t.y2=+t.y2});var S;k?(console.log(l[l.length-1][T]),"year"==k&&(S=d3.timeYear.range(l[0][T],d3.timeYear.offset(l[l.length-1][T],1))),"day"==k&&(S=d3.timeDay.range(l[0][T],d3.timeDay.offset(l[l.length-1][T],1))),"month"==k&&(S=d3.timeMonth.range(l[0][T],d3.timeMonth.offset(l[l.length-1][T],1)))):S=l.map(function(t){return t[T]});var D=d3.scaleBand().range([0,y]).paddingInner(.08);D.domain(S);var E=d3.scaleLinear().range([x,0]),M=d3.stack().offset(d3.stackOffsetDiverging).keys(w)(l);M.forEach(function(t){console.log(t.key),t.forEach(function(e){e.group=t.key})}),E.domain([d3.min(M,a),d3.max(M,r)]).nice();var A,B,R=3;console.log(D.domain().length);var L=Math.round(D.domain().length/10);h&&(L=Math.round(D.domain().length/5)),console.log("tickMod",L),R=D.domain().filter(function(t,e){return!(e%L)}),console.log(R),h?(A=d3.axisBottom(D).tickValues(R).tickFormat(d3.timeFormat("%b %Y")),B=d3.axisLeft(E).tickFormat(function(t){return n(t)}).ticks(5)):(A=d3.axisBottom(D).tickValues(R).tickFormat(d3.timeFormat("%b %Y")),B=d3.axisLeft(E).tickFormat(function(t){return n(t)})),F.append("g").attr("class","x").attr("transform","translate(0,"+x+")").call(A),F.append("g").attr("class","y").call(B),F.selectAll("layer").data(M).enter().append("g").attr("class",function(t){return"layer "+t.key}).style("fill",function(t){return q(t.key)}).selectAll("rect").data(function(t){return t}).enter().append("rect").attr("x",function(t){return D(t.data[T])}).attr("y",function(t){return E(t[1])}).attr("class","barPart").attr("title",function(t){return t.data[t.key]}).attr("data-group",function(t){return t.group}).attr("data-count",function(t){return t.data[t.key]}).attr("height",function(t){return E(t[0])-E(t[1])}).attr("width",D.bandwidth()),F.append("g").attr("class","x").attr("transform","translate(0,"+x+")").call(A),F.append("g").attr("class","y").call(B),p&&this.makeTooltip(".barPart"),F.selectAll(".annotationLine").data(s).enter().append("line").attr("class","annotationLine").attr("x1",function(t){return D(t.x)+D.bandwidth()/2}).attr("y1",function(t){return E(t.y)}).attr("x2",function(t){return D(t.x)+D.bandwidth()/2}).attr("y2",function(t){return E(t.y2)}).style("opacity",1).attr("stroke","#000");var O=d3.select("#footerAnnotations");O.html(""),h?(F.selectAll(".annotationCircles").data(s).enter().append("circle").attr("class","annotationCircle").attr("cy",function(t){return E(t.y2)+o(t)/2}).attr("cx",function(t){return D(t.x)+D.bandwidth()/2}).attr("r",8).attr("fill","#000"),F.selectAll(".annotationTextMobile").data(s).enter().append("text").attr("class","annotationTextMobile").attr("y",function(t){return E(t.y2)+i(t)}).attr("x",function(t){return D(t.x)+D.bandwidth()/2}).style("text-anchor","middle").style("opacity",1).attr("fill","#FFF").text(function(t,e){return e+1}),console.log(s.length),s.length>0&&O.append("span").attr("class","annotationFooterHeader").text("Notes: "),s.forEach(function(t,e){O.append("span").attr("class","annotationFooterNumber").text(e+1+" - "),e<s.length-1?O.append("span").attr("class","annotationFooterText").text(t.text+", "):O.append("span").attr("class","annotationFooterText").text(t.text)})):F.selectAll(".annotationText").data(s).enter().append("text").attr("class","annotationText").attr("y",function(t){return E(t.y2)}).attr("x",function(t){return D(t.x)+D.bandwidth()/2}).style("text-anchor",function(t){return t.align}).style("opacity",1).text(function(t){return t.text})}return(0,_createClass2.default)(t,[{key:"makeTooltip",value:function(t){console.log("make",t);var e=d3.selectAll(t),n=document.querySelector("#graphicContainer").getBoundingClientRect().width,a=d3.select("#graphicContainer").append("div").attr("class","tooltip").attr("id","tooltip").style("position","absolute").style("background-color","white").style("opacity",0);e.on("mouseover",function(t){var e="<b>".concat(t.group,"</b><br>").concat(t.data[t.group]);a.transition().duration(200).style("opacity",.9),a.html(e);var r=document.querySelector("#tooltip").getBoundingClientRect().width,o=d3.mouse(this)[0],i=n/2;o<i?a.style("left",d3.mouse(this)[0]+r/2+"px"):o>=i&&a.style("left",d3.mouse(this)[0]-r+"px"),a.style("top",d3.mouse(this)[1]+"px")}),e.on("mouseout",function(){a.transition().duration(500).style("opacity",0)})}}]),t}();exports.default=StackedBarChart;