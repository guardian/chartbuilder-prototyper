"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_numberFormat=require("../utilities/numberFormat"),LineChart=function t(e){function n(t){return t.offset>0?12:-2}function r(t){return t.offset>0?12:4}(0,_classCallCheck2.default)(this,t);var a=JSON.parse(JSON.stringify(e)),o=a.sheets.data,i=a.sheets.template,l=a.sheets.labels,s=a.sheets.periods,c=a.sheets.key,u=a.sheets.options,d={},f=null;c.length>1&&c.forEach(function(t){d[t.keyName]=t.colour}),""!=i[0].x_axis_cross_y&&(f=+i[0].x_axis_cross_y,f=null);var p,x=d3.select("#chartKey"),h=Math.max(document.documentElement.clientWidth,window.innerWidth||0),m=h<610,y=document.querySelector("#graphicContainer").getBoundingClientRect().width,g=.6*y;p=i[0]["margin-top"]?{top:+i[0]["margin-top"],right:+i[0]["margin-right"],bottom:+i[0]["margin-bottom"],left:+i[0]["margin-left"]}:{top:0,right:0,bottom:20,left:40};var b=!0;u.length>0&&u[0].lineLabelling&&""!=u[0].lineLabelling&&(b=!0===u[0].lineLabelling);var v="yes";i[0].breaks&&(v=i[0].breaks);var k,L=Object.keys(o[0]);i[0].xColumn?(k=i[0].xColumn,L.splice(L.indexOf(k),1)):(k=L[0],L.splice(0,1));var A=["#4daacf","#5db88b","#a2b13e","#8a6929","#b05cc6","#c8a466","#c35f95","#ce592e","#d23d5e","#d89a34","#7277ca","#527b39","#59b74b","#c76c65","#8a6929"],C=y-p.left-p.right,g=g-p.top-p.bottom;d3.select("#graphicContainer svg").remove(),x.html("");var F=d3.select("#graphicContainer").append("svg").attr("width",C+p.left+p.right).attr("height",g+p.top+p.bottom).attr("id","svg").attr("overflow","hidden");if(b&&!m){var T=L.sort(function(t,e){return e.length-t.length})[0];d3.select("#dummyText").remove();var _=F.append("text").attr("x",-50).attr("y",-50).attr("id","dummyText").attr("class","annotationText").text(T),w=_.node().getBBox().width;p.right=p.right+w}C=y-p.left-p.right,F.attr("width",C+p.left+p.right);var E,N=F.append("g").attr("transform","translate("+p.left+","+p.top+")");E="string"==typeof o[0][k]?d3.scaleTime().rangeRound([0,C]):d3.scaleLinear().rangeRound([0,C]);var O;O=i[0].yScaleType?d3[i[0].yScaleType]().range([g,0]).nice():d3.scaleLinear().rangeRound([g,0]);var q=d3.scaleOrdinal().range(A),R={},D=[];L.forEach(function(t){R[t]="yes"===v?d3.line().defined(function(t){return t}).x(function(t){return E(t[k])}).y(function(e){return O(e[t])}):d3.line().x(function(t){return E(t[k])}).y(function(e){return O(e[t])}),o.forEach(function(e){"string"==typeof e[t]?e[t].includes(",")?isNaN(e[t].replace(/,/g,""))||(e[t]=+e[t].replace(/,/g,""),D.push(e[t])):""!=e[t]?isNaN(e[t])||(e[t]=+e[t],D.push(e[t])):""==e[t]&&(e[t]=null):D.push(e[t])})}),m&&L.forEach(function(t){var e=x.append("div").attr("class","keyDiv");e.append("span").attr("class","keyCircle").style("background-color",function(){return d.hasOwnProperty(t)?d[t]:q(t)}),e.append("span").attr("class","keyText").text(t)});var P=d3.timeParse(i[0].dateFormat),S=d3.timeParse(i[0].periodDateFormat);o.forEach(function(t){"string"==typeof t[k]&&(t[k]=P(t[k]))});var B={};L.forEach(function(t){B[t]=[],o.forEach(function(e){if(null!=e[t]){var n={};n[k]=e[k],n[t]=e[t],B[t].push(n)}else B[t].push(null)})}),l.forEach(function(t){"string"==typeof t.x&&(t.x=P(t.x)),"string"==typeof t.y&&(t.y=+t.y),"string"==typeof t.offset&&(t.offset=+t.offset)}),s.forEach(function(t){"string"==typeof t.start&&(t.start=S(t.start),t.end=S(t.end),t.middle=new Date((t.start.getTime()+t.end.getTime())/2))});var H,M=d3.max(D);H=""!=i[0].minY?parseInt(i[0].minY):d3.min(D),E.domain(d3.extent(o,function(t){return t[k]})),console.log(H),O.domain([H,M]);var j,J;J="scaleLog"==i[0].yScaleType?d3.axisLeft(O).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)}).ticks(3):d3.axisLeft(O).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)}).ticks(5),j=m?d3.axisBottom(E).ticks(4):d3.axisBottom(E).ticks(8),d3.selectAll(".periodLine").remove(),d3.selectAll(".periodLabel").remove(),N.selectAll(".periodLine").data(s).enter().append("line").attr("x1",function(t){return E(t.start)}).attr("y1",0).attr("x2",function(t){return E(t.start)}).attr("y2",g).attr("class","periodLine mobHide").attr("stroke","#bdbdbd").attr("opacity",function(t){return t.start<E.domain()[0]?0:1}).attr("stroke-width",1),N.selectAll(".periodLine").data(s).enter().append("line").attr("x1",function(t){return E(t.end)}).attr("y1",0).attr("x2",function(t){return E(t.end)}).attr("y2",g).attr("class","periodLine mobHide").attr("stroke","#bdbdbd").attr("opacity",function(t){return t.end>E.domain()[1]?0:1}).attr("stroke-width",1),N.selectAll(".periodLabel").data(s).enter().append("text").attr("x",function(t){return"middle"==t.labelAlign?E(t.middle):"start"==t.labelAlign?E(t.start)+5:void 0}).attr("y",-5).attr("text-anchor",function(t){return t.labelAlign}).attr("class","periodLabel mobHide").attr("opacity",1).text(function(t){return t.label}),N.append("g").attr("class","x").attr("transform",function(){return null!=f?"translate(0,"+O(f)+")":"translate(0,"+g+")"}).call(j),N.append("g").attr("class","y").call(J),N.append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("fill","#767676").attr("text-anchor","end").text(i[0].yAxisLabel),N.append("text").attr("x",C).attr("y",g-6).attr("fill","#767676").attr("text-anchor","end").text(i[0].xAxisLabel),d3.selectAll(".tick line").attr("stroke","#767676"),d3.selectAll(".tick text").attr("fill","#767676"),d3.selectAll(".domain").attr("stroke","#767676"),L.forEach(function(t){N.append("path").datum(B[t]).attr("fill","none").attr("stroke",function(e){return d.hasOwnProperty(t)?d[t]:q(t)}).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5).attr("d",R[t]);var e=B[t].filter(function(t){return null!=t});console.log(e);e.length;m||(N.append("circle").attr("cy",function(n){return O(e[e.length-1][t])}).attr("fill",function(e){return d.hasOwnProperty(t)?d[t]:q(t)}).attr("cx",function(t){return E(e[e.length-1][k])}).attr("r",4).style("opacity",1),N.append("text").attr("class","annotationText").attr("y",function(n){return O(e[e.length-1][t])+4+0}).attr("x",function(t){return console.log(E(e[e.length-1][k])),E(e[e.length-1][k])+5}).style("opacity",1).attr("text-anchor","start").text(function(e){return t}))}),N.selectAll(".annotationLine").data(l).enter().append("line").attr("class","annotationLine").attr("x1",function(t){return E(t.x)}).attr("y1",function(t){return O(t.y)}).attr("x2",function(t){return E(t.x)}).attr("y2",function(t){return O(t.offset)}).style("opacity",1).attr("stroke","#000");var W=d3.select("#footerAnnotations");W.html(""),m?(N.selectAll(".annotationCircles").data(l).enter().append("circle").attr("class","annotationCircle").attr("cy",function(t){return O(t.offset)+n(t)/2}).attr("cx",function(t){return E(t.x)}).attr("r",8).attr("fill","#000"),N.selectAll(".annotationTextMobile").data(l).enter().append("text").attr("class","annotationTextMobile").attr("y",function(t){return O(t.offset)+r(t)}).attr("x",function(t){return E(t.x)}).style("text-anchor","middle").style("opacity",1).attr("fill","#FFF").text(function(t,e){return e+1}),l.length>0&&W.append("span").attr("class","annotationFooterHeader").text("Notes: "),l.forEach(function(t,e){W.append("span").attr("class","annotationFooterNumber").text(e+1+" - "),e<l.length-1?W.append("span").attr("class","annotationFooterText").text(t.text+", "):W.append("span").attr("class","annotationFooterText").text(t.text)})):N.selectAll(".annotationText").data(l).enter().append("text").attr("class","annotationText").attr("y",function(t){return O(t.offset)+n(t)}).attr("x",function(t){return E(t.x)}).style("text-anchor",function(t){return t.align}).style("opacity",1).text(function(t){return t.text})};exports.default=LineChart;