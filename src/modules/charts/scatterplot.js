"use strict";function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,r)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){(0,_defineProperty2.default)(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_tooltip=_interopRequireDefault(require("./shared/tooltip")),_helpers=_interopRequireDefault(require("../utilities/helpers")),_mustache=_interopRequireDefault(require("../utilities/mustache")),ScatterPlot=function(){function t(e){(0,_classCallCheck2.default)(this,t);var a=this;this.firstTime=!0,this.default=null,this.database=null,this.template=null,this.trendlines=null,this.trendline=null,this.tiptext=null,this.target=null,this.filter=null,this.cats=null,this.x_format=null,this.categories=null,this.x_axis_cross_y=null,this.y_axis_cross_x=null,this.x_label=null,this.y_label=null,this.colours=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6"],this.greyScale=["#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF"],this.symbolTypes=["symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye","symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye"],this.categories=null,this.label_col=null;var r=[];if(this.template=e.sheets.template,this.key=null,this.yTag=e.sheets.template[0].y,this.xTag=e.sheets.template[0].x,this.zero_line_x="TRUE"===e.sheets.template[0].zero_line_x,this.zero_line_y="TRUE"===e.sheets.template[0].zero_line_y,this.database=e.sheets.database,this.database.forEach(function(t){t.x=+t[e.sheets.template[0].x],t.y=+t[e.sheets.template[0].y],"label"in t&&"TRUE"===t.label&&r.push(t)}),this.margin=null,this.template[0]["margin-top"]?this.margin={top:+this.template[0]["margin-top"],right:+this.template[0]["margin-right"],bottom:+this.template[0]["margin-bottom"],left:+this.template[0]["margin-left"]}:this.margin={top:0,right:0,bottom:20,left:40},this.labels=r,console.log(this.template),console.log(this.database),console.log(this.labels),""!=this.template[0].title&&d3.select(".chartTitle").html(a.template[0].title),this.colourKey=d3.scaleOrdinal(),this.greyKey=d3.scaleOrdinal(),"key"in e.sheets&&(this.key=e.sheets.key,""!=e.sheets.key[0])){var l=[],s=[];e.sheets.key.forEach(function(t){l.push(t.key),s.push(t.colour)}),this.colourKey.domain(l).range(s)}""!=this.template[0].categories&&this._createCats(d3),""!=this.template[0].standfirst&&d3.select("#standfirst").html(a.template[0].standfirst),""!=this.template[0].x_format&&(this.x_format=this.template[0].x_format),"TRUE"==this.template[0].trendline&&(this.trendline=!0,this.trendlines=e.sheets.trendline),""!=this.template[0].tooltip&&(this.tiptext=this.template[0].tooltip),""!=this.template[0].filter&&this._createFilters(d3),""!=this.template[0].x_axis_cross_y&&(this.x_axis_cross_y=this.template[0].x_axis_cross_y),""!=this.template[0].y_axis_cross_x&&(this.y_axis_cross_x=this.template[0].y_axis_cross_x),""!=this.template[0].label&&(this.label_col=this.template[0].label_col),""!=this.template[0].x_label?this.x_label=this.template[0].x_label:this.x_label=e.sheets.template[0].x,""!=this.template[0].y_label?this.y_label=this.template[0].y_label:this.y_label=e.sheets.template[0].y,this.hasAnnotations=e.sheets.labels.length>0,this.hasAnnotations&&(this.annotations=e.sheets.labels),this.colourBlindUser=!1,d3.select("#scatterplot_chart_data_source").html(a.template[0].source),this._render(d3),d3.selectAll("#colourBlind").on("click",function(){a.colourBlindUser=!a.colourBlindUser,a.colourBlindUser?d3.select("#colourBlind").text("colour"):d3.select("#colourBlind").text("greyscale"),d3.select("#key").classed("colourvision",!d3.select("#key").classed("colourvision")),this._render(d3)})}return(0,_createClass2.default)(t,[{key:"_createFilters",value:function(t){console.log("Inside the filter function");var e=this;e.filter=e.template[0].filter,e.default=e.template[0].default_filter;var a=[];e.database.forEach(function(t){-1===a.indexOf(t[e.filter])&&a.push(t[e.filter])});for(var r="",l=0;l<a.length;l++)r+='<div data-filter="'+a[l]+'" class="btn filter '+(0==l?"currentfilter":"")+'">'+a[l]+"</div>";t.select("#graphicContainer").html(r)}},{key:"_createCats",value:function(t){var e=this;e.cats=e.template[0].categories;var a=[],r=[],l=[];for(e.database.forEach(function(t){return-1===a.indexOf(t[e.cats])?a.push(t[e.cats]):""});e.symbolTypes.length<a.length;)e.symbolTypes=[].concat((0,_toConsumableArray2.default)(e.symbolTypes),(0,_toConsumableArray2.default)(e.symbolTypes));var s=t.symbol().size(50),n=a.map(function(t,a){return[t,e.symbolTypes[a]]}),i=new Map(n);this.symbolKey=function(e){return s.type(t[i.get(e)]),s()};var o="";if(null!=this.key)""!=this.key[0].key&&this.key.forEach(function(t,e){o+='<div class="keyDiv"><span data-cat="'+t.key+'" class="keyCircle" style="background: '+t.colour+'"></span>',o+=' <span class="keyText">'+t.key+"</span></div>"});else{for(var c=0;c<a.length;c++)r.push(a[c]),l.push(e.colours[c]);this.colourKey.domain(r).range(l),this.greyKey.domain(r).range(this.greyScale),o+='<div class="colour_blind_key">';for(var c=0;c<a.length;c++)o+='<div class="keyDiv"><span data-cat="'+a[c]+'" class="keySymbol"><svg width="12" height="12" viewBox="-6 -6 12 12"><path d="'+e.symbolKey(a[c])+'" stroke="#000" stroke-width="1px" fill="'+this.greyKey(a[c])+'" /></svg></span>',o+=' <span class="keyText">'+a[c]+"</span></div>";o+='</div><div class="colour_vision_key">';for(var c=0;c<a.length;c++)o+='<div class="keyDiv"><span data-cat="'+a[c]+'" class="keyCircle" style="background: '+e.colours[c]+'"></span>',o+=' <span class="keyText">'+a[c]+"</span></div>";o+="</div>"}t.select("#key").html(o)}},{key:"labelizer",value:function(t){var t=t.replace(/_/g," ");return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})}},{key:"resizer",value:function(t){var e=this;window.addEventListener("resize",function(){clearTimeout(document.body.data),document.body.data=setTimeout(function(){console.log("Resize the chart"),e._render(t)},800)})}},{key:"_render",value:function(t){var e,a=this,r=this;e=Math.max(document.documentElement.clientWidth,window.innerWidth||0)<610;var l=document.querySelector("#graphicContainer").getBoundingClientRect().width,s=e?.7*l:.5*l;l=l-r.margin.left-r.margin.right,s=s-r.margin.top-r.margin.bottom,null!=r.filter?r.target=r.database.filter(function(t){return t[r.filter]==r.default}):r.target=r.database,t.select("#graphicContainer svg").remove();var n=function(t){return t.x},i=t.scaleLinear().range([0,l]),o=function(t){return i(n(t))},c=t.axisBottom(i);r.x_format&&c.tickFormat(t.format(r.x_format));var u=function(t){return t.y},d=t.scaleLinear().range([s,0]),h=function(t){return d(u(t))},f=t.axisLeft(d),y=t.select("#graphicContainer").append("svg").attr("width",l+r.margin.left+r.margin.right).attr("height",s+r.margin.top+r.margin.bottom).attr("viewBox","0 0 ".concat(l+r.margin.left+r.margin.right," ").concat(s+r.margin.top+r.margin.bottom)).classed("svg-content",!0).append("g").attr("transform","translate("+r.margin.left+","+r.margin.top+")"),p=r.database.map(function(t){return parseFloat(t.x)}),m=t.min(p),b=t.max(p),_=(r.database.map(function(t){return parseFloat(t.y)}),r.bufferize(m,b)),g=t.min(r.database,function(t){return parseFloat(t.y)}),x=t.max(r.database,function(t){return parseFloat(t.y)});console.log(g,x);var v=r.bufferize(g,x);console.log("xLabels",_),i.domain(_),d.domain(v),this.tooltip=new _tooltip.default("#graphicContainer","tipster"),y.append("g").attr("class","x axis").attr("transform",function(){return null!=r.x_axis_cross_y?"translate(0,"+d(r.x_axis_cross_y)+")":"translate(0,"+s+")"}).call(c).append("text").attr("class","label").attr("x",l).attr("y",-6).style("text-anchor","end").text(r.x_label),y.append("g").attr("class","y axis").attr("transform",function(){if(null!=r.y_axis_cross_x)return"translate("+i(r.y_axis_cross_x)+",0)"}).call(f).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(r.y_label),r.zero_line_x&&y.append("line").attr("class","zeroline").attr("x1",function(){return i(0)}).attr("y1",function(){return 0}).attr("x2",function(){return i(0)}).attr("y2",function(){return s}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),r.zero_line_y&&y.append("line").attr("class","zeroline").attr("x1",function(){return 0}).attr("y1",function(){return d(0)}).attr("x2",function(){return l}).attr("y2",function(){return d(0)}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),y.selectAll(".dot-label").data(r.labels).enter().append("text").attr("class","dot-label").attr("x",o).attr("dy",15).attr("text-anchor","middle").attr("y",h).text(function(t){return t[r.label_col]});var k=null,F=function(t){return(0,_mustache.default)(a.tiptext,_objectSpread({},_helpers.default,{},t))};if(k=r.colourBlindUser?y.selectAll(".dot").data(r.target).enter().append("path").attr("class",function(t){return"dot "+t[r.cats]}).attr("stroke","#000").attr("stroke-width","1px").attr("transform",function(t){return"translate(".concat(i(t.x),",").concat(d(t.y),")")}).style("opacity",.8).style("fill",function(t){return r.greyKey(t[r.cats])}).attr("d",function(t){return r.symbolKey(t[r.cats])}):y.selectAll(".dot").data(r.target).enter().append("circle").attr("class",function(t){return"dot "+t[r.cats]}).attr("r",3.5).attr("cx",o).attr("cy",h).style("fill",function(t){return null==r.cats?"#4bc6df":r.colourKey(t[r.cats])}).attr("stroke",function(t){return""!=t.label?"#000":"#bdbdbd"}).attr("stroke-width",function(){return"1px"}),this.tooltip.bindEvents(k,l,s+r.margin.top+r.margin.bottom,F,{top:e?s/2:null,topOffset:e?null:10,leftOffset:5}),null!=r.filter&&t.selectAll(".filter").on("click",r.filters),null!=r.cats){var C=r.colourBlindUser?".keySymbol":".keyCircle";t.selectAll(C).on("click",r.stated)}if(r.trendline){var w=r.trendlines.filter(function(t){return t.trendline==r.default});0==w.length&&(w=r.trendlines.filter(function(t){return"default"==t.trendline})),console.log(w);var O=parseFloat(w[0].min_x),T=parseFloat(w[0].min_y),q=parseFloat(w[0].max_x),A=parseFloat(w[0].max_y),D=[[O,T,q,A]],w=y.selectAll(".trendline").data(D);w.enter().append("line").attr("class","trendline").attr("x1",function(t){return i(t[0])}).attr("y1",function(t){return d(t[1])}).attr("x2",function(t){return i(t[2])}).attr("y2",function(t){return d(t[3])}).attr("stroke","black").attr("stroke-width",1).style("opacity",1).style("stroke-dasharray","3, 3")}if(r.hasAnnotations)for(var E=0;E<r.annotations.length;E++)!function(){var t="TRUE"===r.annotations[E].scaled_x,e=t?i(+r.annotations[E].x):+r.annotations[E].x,a="TRUE"===r.annotations[E].scaled_y,l=a?d(+r.annotations[E].y):+r.annotations[E].y,s=""===r.annotations[E].rotation?0:r.annotations[E].rotation;y.append("text").attr("class","annotations mobHide").attr("x",e).attr("y",l).style("text-anchor",r.annotations[E]["text-anchor"]).text(r.annotations[E].text).attr("transform",function(t){return"rotate(".concat(s,",").concat(e,",").concat(l,")")})}()}},{key:"calcLinear",value:function(t,e,a,r,l){var s=t.length,n=[];t.forEach(function(t,r){var l={};l.x=t[e],l.y=t[a],l.mult=l.x*l.y,n.push(l)});var i=0,o=0,c=0,u=0;n.forEach(function(t){i+=t.mult,o+=t.x,c+=t.y,u+=t.x*t.x});var d=i*s,h=o*c,f=u*s,y=o*o,p=(d-h)/(f-y),m=c,b=p*o,h=(m-b)/s;return{ptA:{x:r,y:p*r+h},ptB:{y:l,x:(l-h)/p}}}},{key:"bufferize",value:function(t,e){var a=(e-t)/100*5;return[t-a,e+a]}},{key:"stated",value:function(){var t=this,e=d3.select(this),a=e.attr("data-cat"),r=d3.select(this).classed("greyedOut");d3.select(this).classed("greyedOut",!r);var l=d3.selectAll("#graphicContainer .dot."+a),s=d3.selectAll("#graphicContainer .trendline."+a);r?l.style("display","block"):l.style("display","none"),r?s.style("opacity",.7):s.style("opacity",0),void 0!=t.categories&&t.categories.filter(function(t){t.name==a&&(t.status=r)})}},{key:"_filters",value:function(t){var e=this,a=t.select(this);e.default=a.attr("data-filter");t.selectAll(".filter").classed("currentfilter",!1);var r=t.select(this).classed("currentfilter");t.select(this).classed("currentfilter",!r),e._render(t)}},{key:"_colorize",value:function(t){return this.categories.filter(function(e){return e.name==t})[0].colour}}]),t}();exports.default=ScatterPlot;