"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),ScatterPlot=function(){function t(e,s){(0,_classCallCheck2.default)(this,t);var a=this;this.firstTime=!0,this.default=null,this.database=null,this.settings=null,this.trendlines=null,this.trendline=null,this.tiptext=null,this.target=null,this.filter=null,this.cats=null,this.x_format=null,this.categories=null,this.x_axis_cross_y=null,this.y_axis_cross_x=null,this.x_label=null,this.y_label=null,this.colours=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6"],this.greyScale=["#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF"],this.symbolTypes=["symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye","symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye"],this.categories=null,this.label_col=null;var n=[];if(this.settings=e.sheets.settings,this.key=null,this.yTag=e.sheets.settings[0].y,this.xTag=e.sheets.settings[0].x,this.zero_line_x="TRUE"===e.sheets.settings[0].zero_line_x,this.zero_line_y="TRUE"===e.sheets.settings[0].zero_line_y,this.database=e.sheets.database,this.database.forEach(function(t){t.x=+t[e.sheets.settings[0].x],t.y=+t[e.sheets.settings[0].y],"label"in t&&"TRUE"===t.label&&n.push(t)}),this.labels=n,console.log(this.settings),console.log(this.database),console.log(this.labels),""!=this.settings[0].title&&s.select(".chartTitle").html(a.settings[0].title),this.colourKey=s.scaleOrdinal(),this.greyKey=s.scaleOrdinal(),"key"in e.sheets&&(this.key=e.sheets.key,""!=e.sheets.key[0])){var r=[],l=[];e.sheets.key.forEach(function(t){r.push(t.key),l.push(t.colour)}),this.colourKey.domain(r).range(l)}""!=this.settings[0].categories&&this._createCats(s),""!=this.settings[0].standfirst&&s.select("#standfirst").html(a.settings[0].standfirst),""!=this.settings[0].x_format&&(this.x_format=this.settings[0].x_format),"TRUE"==this.settings[0].trendline&&(this.trendline=!0,this.trendlines=e.sheets.trendline),""!=this.settings[0].tooltip&&(this.tiptext=this.settings[0].tooltip),""!=this.settings[0].filter&&this._createFilters(s),""!=this.settings[0].x_axis_cross_y&&(this.x_axis_cross_y=this.settings[0].x_axis_cross_y),""!=this.settings[0].y_axis_cross_x&&(this.y_axis_cross_x=this.settings[0].y_axis_cross_x),""!=this.settings[0].label&&(this.label_col=this.settings[0].label_col),""!=this.settings[0].x_label?this.x_label=this.settings[0].x_label:this.x_label=e.sheets.settings[0].x,""!=this.settings[0].y_label?this.y_label=this.settings[0].y_label:this.y_label=e.sheets.settings[0].y,this.hasAnnotations=e.sheets.labels.length>0,this.hasAnnotations&&(this.annotations=e.sheets.labels),this.colourBlindUser=!1,s.select("#scatterplot_chart_data_source").html(a.settings[0].source),this._render(s),s.selectAll("#colourBlind").on("click",function(){a.colourBlindUser=!a.colourBlindUser,a.colourBlindUser?s.select("#colourBlind").text("colour"):s.select("#colourBlind").text("greyscale"),s.select("#key").classed("colourvision",!s.select("#key").classed("colourvision")),this._render(s)}),this.resizer()}return(0,_createClass2.default)(t,[{key:"_createFilters",value:function(t){console.log("Inside the filter function");var e=this;e.filter=e.settings[0].filter,e.default=e.settings[0].default_filter;var s=[];e.database.forEach(function(t){-1===s.indexOf(t[e.filter])&&s.push(t[e.filter])});for(var a="",n=0;n<s.length;n++)a+='<div data-filter="'+s[n]+'" class="btn filter '+(0==n?"currentfilter":"")+'">'+s[n]+"</div>";t.select("#graphicContainer").html(a)}},{key:"_createCats",value:function(t){var e=this;e.cats=e.settings[0].categories;var s=[],a=[],n=[];for(e.database.forEach(function(t){return-1===s.indexOf(t[e.cats])?s.push(t[e.cats]):""});e.symbolTypes.length<s.length;)e.symbolTypes=[].concat((0,_toConsumableArray2.default)(e.symbolTypes),(0,_toConsumableArray2.default)(e.symbolTypes));var r=t.symbol().size(50),l=s.map(function(t,s){return[t,e.symbolTypes[s]]}),i=new Map(l);this.symbolKey=function(e){return r.type(t[i.get(e)]),r()};var o="";if(null!=this.key)""!=this.key[0].key&&this.key.forEach(function(t,e){o+='<div class="keyDiv"><span data-cat="'+t.key+'" class="keyCircle" style="background: '+t.colour+'"></span>',o+=' <span class="keyText">'+t.key+"</span></div>"});else{for(var c=0;c<s.length;c++)a.push(s[c]),n.push(e.colours[c]);this.colourKey.domain(a).range(n),this.greyKey.domain(a).range(this.greyScale),o+='<div class="colour_blind_key">';for(var c=0;c<s.length;c++)o+='<div class="keyDiv"><span data-cat="'+s[c]+'" class="keySymbol"><svg width="12" height="12" viewBox="-6 -6 12 12"><path d="'+e.symbolKey(s[c])+'" stroke="#000" stroke-width="1px" fill="'+this.greyKey(s[c])+'" /></svg></span>',o+=' <span class="keyText">'+s[c]+"</span></div>";o+='</div><div class="colour_vision_key">';for(var c=0;c<s.length;c++)o+='<div class="keyDiv"><span data-cat="'+s[c]+'" class="keyCircle" style="background: '+e.colours[c]+'"></span>',o+=' <span class="keyText">'+s[c]+"</span></div>";o+="</div>"}t.select("#key").html(o)}},{key:"labelizer",value:function(t){var t=t.replace(/_/g," ");return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})}},{key:"resizer",value:function(t){window.addEventListener("resize",function(){clearTimeout(document.body.data),document.body.data=setTimeout(function(){console.log("Resize the chart"),this._render(t)},800)})}},{key:"_render",value:function(t){var e,s=this,a=Math.max(document.documentElement.clientWidth,window.innerWidth||0);e=a<610;var n=document.querySelector("#graphicContainer").getBoundingClientRect().width,r=e?.7*n:.5*n,l={top:20,right:20,bottom:35,left:45},n=n-l.left-l.right,r=r-l.top-l.bottom;null!=s.filter?s.target=s.database.filter(function(t){return t[s.filter]==s.default}):s.target=s.database,t.select("#graphicContainer svg").remove();var i=function(t){return t.x},o=t.scaleLinear().range([0,n]),c=function(t){return o(i(t))},u=t.axisBottom(o);s.x_format&&u.tickFormat(t.format(s.x_format));var d=function(t){return t.y},y=t.scaleLinear().range([r,0]),h=function(t){return y(d(t))},f=t.axisLeft(y),p=t.select("#graphicContainer").append("svg").attr("width",n+l.left+l.right).attr("height",r+l.top+l.bottom).attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 ".concat(n+l.left+l.right," ").concat(r+l.top+l.bottom)).classed("svg-content",!0).append("g").attr("transform","translate("+l.left+","+l.top+")"),b=s.database.map(function(t){return parseFloat(t.x)}),g=t.min(b),x=t.max(b),_=(s.database.map(function(t){return parseFloat(t.y)}),s.bufferize(g,x)),m=t.min(s.database,function(t){return parseFloat(t.y)}),v=t.max(s.database,function(t){return parseFloat(t.y)});console.log(m,v);var k=s.bufferize(m,v);console.log("xLabels",_),o.domain(_),y.domain(k);var F=t.select("body").append("div").attr("class","tipster").style("position","absolute").style("background-color","white").style("opacity",0);if(p.append("g").attr("class","x axis").attr("transform",function(){return null!=s.x_axis_cross_y?"translate(0,"+y(s.x_axis_cross_y)+")":"translate(0,"+r+")"}).call(u).append("text").attr("class","label").attr("x",n).attr("y",-6).style("text-anchor","end").text(s.x_label),p.append("g").attr("class","y axis").attr("transform",function(){if(null!=s.y_axis_cross_x)return"translate("+o(s.y_axis_cross_x)+",0)"}).call(f).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(s.y_label),s.zero_line_x&&p.append("line").attr("class","zeroline").attr("x1",function(){return o(0)}).attr("y1",function(){return 0}).attr("x2",function(){return o(0)}).attr("y2",function(){return r}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),s.zero_line_y&&p.append("line").attr("class","zeroline").attr("x1",function(){return 0}).attr("y1",function(){return y(0)}).attr("x2",function(){return n}).attr("y2",function(){return y(0)}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),p.selectAll(".dot-label").data(s.labels).enter().append("text").attr("class","dot-label").attr("x",c).attr("dy",15).attr("text-anchor","middle").attr("y",h).text(function(t){return t[s.label_col]}),s.colourBlindUser?p.selectAll(".dot").data(s.target).enter().append("path").attr("class",function(t){return"dot "+t[s.cats]}).attr("stroke","#000").attr("stroke-width","1px").attr("transform",function(t){return"translate(".concat(o(t.x),",").concat(y(t.y),")")}).style("opacity",.8).style("fill",function(t){return s.greyKey(t[s.cats])}).attr("d",function(t){return s.symbolKey(t[s.cats])}).on("mouseover",function(a){null!=s.tiptext&&(F.transition().duration(200).style("opacity",.9),F.html(s.tipster(a)).style("left",s.tooltip(t.event.pageX,n)+"px").style("top",(e?r/2:t.event.pageY+10)+"px"))}).on("mouseout",function(){null!=s.tiptext&&F.transition().duration(500).style("opacity",0)}):p.selectAll(".dot").data(s.target).enter().append("circle").attr("class",function(t){return"dot "+t[s.cats]}).attr("r",3.5).attr("cx",c).attr("cy",h).style("fill",function(t){return null==s.cats?"#4bc6df":s.colourKey(t[s.cats])}).attr("stroke",function(t){return""!=t.label?"#000":"#bdbdbd"}).attr("stroke-width",function(){return"1px"}).on("mouseover",function(a){null!=s.tiptext&&(F.transition().duration(200).style("opacity",.9),F.html(s.tipster(a)).style("left",s.tooltip(t.event.pageX,n)+"px").style("top",(e?r/2:t.event.pageY+10)+"px"))}).on("mouseout",function(t){null!=s.tiptext&&F.transition().duration(500).style("opacity",0)}),null!=s.filter&&t.selectAll(".filter").on("click",s.filters),null!=s.cats){var C=s.colourBlindUser?".keySymbol":".keyCircle";t.selectAll(C).on("click",s.stated)}if(s.trendline){var T=s.trendlines.filter(function(t){return t.trendline==s.default});0==T.length&&(T=s.trendlines.filter(function(t){return"default"==t.trendline})),console.log(T);var A=parseFloat(T[0].min_x),w=parseFloat(T[0].min_y),z=parseFloat(T[0].max_x),E=parseFloat(T[0].max_y),B=[[A,w,z,E]],T=p.selectAll(".trendline").data(B);T.enter().append("line").attr("class","trendline").attr("x1",function(t){return o(t[0])}).attr("y1",function(t){return y(t[1])}).attr("x2",function(t){return o(t[2])}).attr("y2",function(t){return y(t[3])}).attr("stroke","black").attr("stroke-width",1).style("opacity",1).style("stroke-dasharray","3, 3")}if(s.hasAnnotations)for(var R=0;R<s.annotations.length;R++)p.append("text").attr("class","annotations").attr("x",function(t){return"TRUE"===s.annotations[R].scaled_x?o(+s.annotations[R].x):+s.annotations[R].x}).attr("y",function(t){return"TRUE"===s.annotations[R].scaled_y?y(+s.annotations[R].y):+s.annotations[R].y}).style("text-anchor",s.annotations[R]["text-anchor"]).text(s.annotations[R].text)}},{key:"calcLinear",value:function(t,e,s,a,n){var r=t.length,l=[];t.forEach(function(t,a){var n={};n.x=t[e],n.y=t[s],n.mult=n.x*n.y,l.push(n)});var i=0,o=0,c=0,u=0;l.forEach(function(t){i+=t.mult,o+=t.x,c+=t.y,u+=t.x*t.x});var d=i*r,y=o*c,h=u*r,f=o*o,p=(d-y)/(h-f),b=c,g=p*o,y=(b-g)/r;return{ptA:{x:a,y:p*a+y},ptB:{y:n,x:(n-y)/p}}}},{key:"bufferize",value:function(t,e){var s=(e-t)/100*5;return[t-s,e+s]}},{key:"tipster",value:function(t){var e=this;return Handlebars.compile(e.tiptext)(t)}},{key:"tooltip",value:function(t,e){return e<500?e/2-100:t>e/2?t-235:t+5}},{key:"stated",value:function(){var t=this,e=d3.select(this),s=e.attr("data-cat"),a=d3.select(this).classed("greyedOut");d3.select(this).classed("greyedOut",!a);var n=d3.selectAll("#graphicContainer .dot."+s),r=d3.selectAll("#graphicContainer .trendline."+s);a?n.style("display","block"):n.style("display","none"),a?r.style("opacity",.7):r.style("opacity",0),void 0!=t.categories&&t.categories.filter(function(t){t.name==s&&(t.status=a)})}},{key:"_filters",value:function(t){var e=this,s=t.select(this);e.default=s.attr("data-filter");t.selectAll(".filter").classed("currentfilter",!1);var a=t.select(this).classed("currentfilter");t.select(this).classed("currentfilter",!a),e._render(t)}},{key:"_colorize",value:function(t){return this.categories.filter(function(e){return e.name==t})[0].colour}}]),t}();exports.default=ScatterPlot;