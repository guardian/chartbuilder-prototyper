"use strict";function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,r)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){(0,_defineProperty2.default)(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),ScatterPlot=function(){function t(e){(0,_classCallCheck2.default)(this,t);var a=this;this.firstTime=!0,this.default=null,this.database=null,this.template=null,this.trendlines=null,this.trendline=null,this.tiptext=null,this.target=null,this.filter=null,this.cats=null,this.x_format=null,this.categories=null,this.x_axis_cross_y=null,this.y_axis_cross_x=null,this.x_label=null,this.y_label=null,this.colours=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6"],this.greyScale=["#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#bdbdbd","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF","#FFFFFF"],this.symbolTypes=["symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye","symbolCircle","symbolCross","symbolDiamond","symbolSquare","symbolStar","symbolTriangle","symbolWye"],this.categories=null,this.label_col=null;var r=[];if(this.template=e.sheets.template,this.key=null,this.yTag=e.sheets.template[0].y,this.xTag=e.sheets.template[0].x,this.zero_line_x="TRUE"===e.sheets.template[0].zero_line_x,this.zero_line_y="TRUE"===e.sheets.template[0].zero_line_y,this.database=e.sheets.database,this.database.forEach(function(t){t.x=+t[e.sheets.template[0].x],t.y=+t[e.sheets.template[0].y],"label"in t&&"TRUE"===t.label&&r.push(t)}),this.margin=null,this.template[0]["margin-top"]?this.margin={top:+this.template[0]["margin-top"],right:+this.template[0]["margin-right"],bottom:+this.template[0]["margin-bottom"],left:+this.template[0]["margin-left"]}:this.margin={top:0,right:0,bottom:20,left:40},this.utilities={decimals:function(t){var e=t.split(",");return parseFloat(this[e[0]]).toFixed(e[1])},nicedate:function(t){var e=this[t];return moment(e).format("MMM D")}},this.labels=r,console.log(this.template),console.log(this.database),console.log(this.labels),""!=this.template[0].title&&d3.select(".chartTitle").html(a.template[0].title),this.colourKey=d3.scaleOrdinal(),this.greyKey=d3.scaleOrdinal(),"key"in e.sheets&&(this.key=e.sheets.key,""!=e.sheets.key[0])){var n=[],l=[];e.sheets.key.forEach(function(t){n.push(t.key),l.push(t.colour)}),this.colourKey.domain(n).range(l)}""!=this.template[0].categories&&this._createCats(d3),""!=this.template[0].standfirst&&d3.select("#standfirst").html(a.template[0].standfirst),""!=this.template[0].x_format&&(this.x_format=this.template[0].x_format),"TRUE"==this.template[0].trendline&&(this.trendline=!0,this.trendlines=e.sheets.trendline),""!=this.template[0].tooltip&&(this.tiptext=this.template[0].tooltip),""!=this.template[0].filter&&this._createFilters(d3),""!=this.template[0].x_axis_cross_y&&(this.x_axis_cross_y=this.template[0].x_axis_cross_y),""!=this.template[0].y_axis_cross_x&&(this.y_axis_cross_x=this.template[0].y_axis_cross_x),""!=this.template[0].label&&(this.label_col=this.template[0].label_col),""!=this.template[0].x_label?this.x_label=this.template[0].x_label:this.x_label=e.sheets.template[0].x,""!=this.template[0].y_label?this.y_label=this.template[0].y_label:this.y_label=e.sheets.template[0].y,this.hasAnnotations=e.sheets.labels.length>0,this.hasAnnotations&&(this.annotations=e.sheets.labels),this.colourBlindUser=!1,d3.select("#scatterplot_chart_data_source").html(a.template[0].source),this._render(d3),d3.selectAll("#colourBlind").on("click",function(){a.colourBlindUser=!a.colourBlindUser,a.colourBlindUser?d3.select("#colourBlind").text("colour"):d3.select("#colourBlind").text("greyscale"),d3.select("#key").classed("colourvision",!d3.select("#key").classed("colourvision")),this._render(d3)})}return(0,_createClass2.default)(t,[{key:"_createFilters",value:function(t){console.log("Inside the filter function");var e=this;e.filter=e.template[0].filter,e.default=e.template[0].default_filter;var a=[];e.database.forEach(function(t){-1===a.indexOf(t[e.filter])&&a.push(t[e.filter])});for(var r="",n=0;n<a.length;n++)r+='<div data-filter="'+a[n]+'" class="btn filter '+(0==n?"currentfilter":"")+'">'+a[n]+"</div>";t.select("#graphicContainer").html(r)}},{key:"_createCats",value:function(t){var e=this;e.cats=e.template[0].categories;var a=[],r=[],n=[];for(e.database.forEach(function(t){return-1===a.indexOf(t[e.cats])?a.push(t[e.cats]):""});e.symbolTypes.length<a.length;)e.symbolTypes=[].concat((0,_toConsumableArray2.default)(e.symbolTypes),(0,_toConsumableArray2.default)(e.symbolTypes));var l=t.symbol().size(50),s=a.map(function(t,a){return[t,e.symbolTypes[a]]}),i=new Map(s);this.symbolKey=function(e){return l.type(t[i.get(e)]),l()};var o="";if(null!=this.key)""!=this.key[0].key&&this.key.forEach(function(t,e){o+='<div class="keyDiv"><span data-cat="'+t.key+'" class="keyCircle" style="background: '+t.colour+'"></span>',o+=' <span class="keyText">'+t.key+"</span></div>"});else{for(var c=0;c<a.length;c++)r.push(a[c]),n.push(e.colours[c]);this.colourKey.domain(r).range(n),this.greyKey.domain(r).range(this.greyScale),o+='<div class="colour_blind_key">';for(var c=0;c<a.length;c++)o+='<div class="keyDiv"><span data-cat="'+a[c]+'" class="keySymbol"><svg width="12" height="12" viewBox="-6 -6 12 12"><path d="'+e.symbolKey(a[c])+'" stroke="#000" stroke-width="1px" fill="'+this.greyKey(a[c])+'" /></svg></span>',o+=' <span class="keyText">'+a[c]+"</span></div>";o+='</div><div class="colour_vision_key">';for(var c=0;c<a.length;c++)o+='<div class="keyDiv"><span data-cat="'+a[c]+'" class="keyCircle" style="background: '+e.colours[c]+'"></span>',o+=' <span class="keyText">'+a[c]+"</span></div>";o+="</div>"}t.select("#key").html(o)}},{key:"labelizer",value:function(t){var t=t.replace(/_/g," ");return t.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})}},{key:"resizer",value:function(t){var e=this;window.addEventListener("resize",function(){clearTimeout(document.body.data),document.body.data=setTimeout(function(){console.log("Resize the chart"),e._render(t)},800)})}},{key:"_render",value:function(t){var e,a=this,r=Math.max(document.documentElement.clientWidth,window.innerWidth||0);e=r<610;var n=document.querySelector("#graphicContainer").getBoundingClientRect().width,l=e?.7*n:.5*n;n=n-a.margin.left-a.margin.right,l=l-a.margin.top-a.margin.bottom,null!=a.filter?a.target=a.database.filter(function(t){return t[a.filter]==a.default}):a.target=a.database,t.select("#graphicContainer svg").remove();var s=function(t){return t.x},i=t.scaleLinear().range([0,n]),o=function(t){return i(s(t))},c=t.axisBottom(i);a.x_format&&c.tickFormat(t.format(a.x_format));var u=function(t){return t.y},d=t.scaleLinear().range([l,0]),y=function(t){return d(u(t))},h=t.axisLeft(d),p=t.select("#graphicContainer").append("svg").attr("width",n+a.margin.left+a.margin.right).attr("height",l+a.margin.top+a.margin.bottom).attr("viewBox","0 0 ".concat(n+a.margin.left+a.margin.right," ").concat(l+a.margin.top+a.margin.bottom)).classed("svg-content",!0).append("g").attr("transform","translate("+a.margin.left+","+a.margin.top+")"),f=a.database.map(function(t){return parseFloat(t.x)}),m=t.min(f),b=t.max(f),x=(a.database.map(function(t){return parseFloat(t.y)}),a.bufferize(m,b)),g=t.min(a.database,function(t){return parseFloat(t.y)}),_=t.max(a.database,function(t){return parseFloat(t.y)});console.log(g,_);var v=a.bufferize(g,_);console.log("xLabels",x),i.domain(x),d.domain(v);var k=t.select("body").append("div").attr("class","tipster").style("position","absolute").style("background-color","white").style("opacity",0);if(p.append("g").attr("class","x axis").attr("transform",function(){return null!=a.x_axis_cross_y?"translate(0,"+d(a.x_axis_cross_y)+")":"translate(0,"+l+")"}).call(c).append("text").attr("class","label").attr("x",n).attr("y",-6).style("text-anchor","end").text(a.x_label),p.append("g").attr("class","y axis").attr("transform",function(){if(null!=a.y_axis_cross_x)return"translate("+i(a.y_axis_cross_x)+",0)"}).call(h).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(a.y_label),a.zero_line_x&&p.append("line").attr("class","zeroline").attr("x1",function(){return i(0)}).attr("y1",function(){return 0}).attr("x2",function(){return i(0)}).attr("y2",function(){return l}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),a.zero_line_y&&p.append("line").attr("class","zeroline").attr("x1",function(){return 0}).attr("y1",function(){return d(0)}).attr("x2",function(){return n}).attr("y2",function(){return d(0)}).attr("stroke","lightgrey").attr("stroke-width",1).style("opacity",1),p.selectAll(".dot-label").data(a.labels).enter().append("text").attr("class","dot-label").attr("x",o).attr("dy",15).attr("text-anchor","middle").attr("y",y).text(function(t){return t[a.label_col]}),a.colourBlindUser?p.selectAll(".dot").data(a.target).enter().append("path").attr("class",function(t){return"dot "+t[a.cats]}).attr("stroke","#000").attr("stroke-width","1px").attr("transform",function(t){return"translate(".concat(i(t.x),",").concat(d(t.y),")")}).style("opacity",.8).style("fill",function(t){return a.greyKey(t[a.cats])}).attr("d",function(t){return a.symbolKey(t[a.cats])}).on("mouseover",function(r){null!=a.tiptext&&(k.transition().duration(200).style("opacity",.9),k.html(a.tipster(r)).style("left",a.tooltip(t.event.pageX,n)+"px").style("top",(e?l/2:t.event.pageY+10)+"px"))}).on("mouseout",function(){null!=a.tiptext&&k.transition().duration(500).style("opacity",0)}):p.selectAll(".dot").data(a.target).enter().append("circle").attr("class",function(t){return"dot "+t[a.cats]}).attr("r",3.5).attr("cx",o).attr("cy",y).style("fill",function(t){return null==a.cats?"#4bc6df":a.colourKey(t[a.cats])}).attr("stroke",function(t){return""!=t.label?"#000":"#bdbdbd"}).attr("stroke-width",function(){return"1px"}).on("mouseover",function(r){null!=a.tiptext&&(k.transition().duration(200).style("opacity",.9),k.html(a.tipster(r)).style("left",a.tooltip(t.event.pageX,n)+"px").style("top",(e?l/2:t.event.pageY+10)+"px"))}).on("mouseout",function(t){null!=a.tiptext&&k.transition().duration(500).style("opacity",0)}),null!=a.filter&&t.selectAll(".filter").on("click",a.filters),null!=a.cats){var F=a.colourBlindUser?".keySymbol":".keyCircle";t.selectAll(F).on("click",a.stated)}if(a.trendline){var C=a.trendlines.filter(function(t){return t.trendline==a.default});0==C.length&&(C=a.trendlines.filter(function(t){return"default"==t.trendline})),console.log(C);var w=parseFloat(C[0].min_x),O=parseFloat(C[0].min_y),T=parseFloat(C[0].max_x),A=parseFloat(C[0].max_y),z=[[w,O,T,A]],C=p.selectAll(".trendline").data(z);C.enter().append("line").attr("class","trendline").attr("x1",function(t){return i(t[0])}).attr("y1",function(t){return d(t[1])}).attr("x2",function(t){return i(t[2])}).attr("y2",function(t){return d(t[3])}).attr("stroke","black").attr("stroke-width",1).style("opacity",1).style("stroke-dasharray","3, 3")}if(a.hasAnnotations)for(var D=0;D<a.annotations.length;D++)!function(){var t="TRUE"===a.annotations[D].scaled_x,e=t?i(+a.annotations[D].x):+a.annotations[D].x,r="TRUE"===a.annotations[D].scaled_y,n=r?d(+a.annotations[D].y):+a.annotations[D].y,l=""===a.annotations[D].rotation?0:a.annotations[D].rotation;p.append("text").attr("class","annotations mobHide").attr("x",e).attr("y",n).style("text-anchor",a.annotations[D]["text-anchor"]).text(a.annotations[D].text).attr("transform",function(t){return"rotate(".concat(l,",").concat(e,",").concat(n,")")})}()}},{key:"calcLinear",value:function(t,e,a,r,n){var l=t.length,s=[];t.forEach(function(t,r){var n={};n.x=t[e],n.y=t[a],n.mult=n.x*n.y,s.push(n)});var i=0,o=0,c=0,u=0;s.forEach(function(t){i+=t.mult,o+=t.x,c+=t.y,u+=t.x*t.x});var d=i*l,y=o*c,h=u*l,p=o*o,f=(d-y)/(h-p),m=c,b=f*o,y=(m-b)/l;return{ptA:{x:r,y:f*r+y},ptB:{y:n,x:(n-y)/f}}}},{key:"bufferize",value:function(t,e){var a=(e-t)/100*5;return[t-a,e+a]}},{key:"tipster",value:function(t){var e=this;return e.mustache(e.tiptext,_objectSpread({},e.utilities,{},t))}},{key:"tooltip",value:function(t,e){return e<500?e/2-100:t>e/2?t-235:t+5}},{key:"stated",value:function(){var t=this,e=d3.select(this),a=e.attr("data-cat"),r=d3.select(this).classed("greyedOut");d3.select(this).classed("greyedOut",!r);var n=d3.selectAll("#graphicContainer .dot."+a),l=d3.selectAll("#graphicContainer .trendline."+a);r?n.style("display","block"):n.style("display","none"),r?l.style("opacity",.7):l.style("opacity",0),void 0!=t.categories&&t.categories.filter(function(t){t.name==a&&(t.status=r)})}},{key:"_filters",value:function(t){var e=this,a=t.select(this);e.default=a.attr("data-filter");t.selectAll(".filter").classed("currentfilter",!1);var r=t.select(this).classed("currentfilter");t.select(this).classed("currentfilter",!r),e._render(t)}},{key:"_colorize",value:function(t){return this.categories.filter(function(e){return e.name==t})[0].colour}},{key:"mustache",value:function(t,e,a,r){function n(t,e){return e=e.pop?e:e.split("."),t=t[e.shift()],t=null!=t?t:"",0 in e?n(t,e):t}var l,s=this.mustache,i="";e=Array.isArray(e)?e:e?[e]:[],e=r?0 in e?[]:[1]:e;for(l=0;l<e.length;l++){var o,c="",u=0,d="object"==(0,_typeof2.default)(e[l])?e[l]:{};d=Object.assign({},a,d),d[""]={"":e[l]},t.replace(/([\s\S]*?)({{((\/)|(\^)|#)(.*?)}}|$)/g,function(t,e,a,r,l,y,h){u?c+=u&&!l||u>1?t:e:(i+=e.replace(/{{{(.*?)}}}|{{(!?)(&?)(>?)(.*?)}}/g,function(t,e,a,r,l,i){return e?n(d,e):r?n(d,i):l?s(n(d,i),d):a?"":new Option(n(d,i)).innerHTML}),o=y),l?--u||(h=n(d,h),/^f/.test((0,_typeof2.default)(h))?i+=h.call(d,c,function(t){return s(t,d)}):i+=s(c,h,d,o),c=""):++u})}return i}}]),t}();exports.default=ScatterPlot;