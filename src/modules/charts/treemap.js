"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_tooltip=_interopRequireDefault(require("./tooltip")),d3=_interopRequireDefault(require("d3")),TreeMap=function(){function t(e,r){(0,_classCallCheck2.default)(this,t),this.width=document.querySelector("#graphicContainer").getBoundingClientRect().width,this.height=r?1.2361009775*this.width:.61803398875*this.width,d3.select("#graphicContainer svg").remove(),d3.select("#tooltip").remove(),this.treemap=d3.treemap().size([this.width,this.height]).padding(1).round(!0);var n=d3.select("#graphicContainer").append("svg").attr("viewBox",[0,0,this.width,this.height]),a=this._constructStratifiedData(e);_tooltip.default.prepareTooltip(d3),this._render(n,a)}return(0,_createClass2.default)(t,[{key:"_constructStratifiedData",value:function(t){var e=[],r=new Set;t.forEach(function(t){r.add(t.categoryName)}),t.forEach(function(t){r.has(t.categoryParent)||(r.add(t.categoryParent),e.push({categoryName:t.categoryParent,categoryParent:"root"}))});var n=[{categoryName:"root",categoryParent:""}].concat(e,(0,_toConsumableArray2.default)(t)),a=d3.stratify().id(function(t){return t.categoryName}).parentId(function(t){return"root"!=t.categoryName?null==t.categoryParent||""==t.categoryParent?"root":t.categoryParent:null})(n).sum(function(t){return t.categorySize}).sort(function(t,e){return e.height-t.height||e.value-t.value});return this.root=a,a}},{key:"_render",value:function(t,e){var r=this;console.log("rendering"),console.log(e),this.root=e,e.depth=0,this.treemap(e);var n=e.leaves(),a=d3.scaleLinear().range([0,this.width]).domain([e.x0,e.x1]),i=d3.scaleLinear().range([0,this.height]).domain([e.y0,e.y1]),o=t.append("g").attr("class","parent").selectAll("g").data(n).enter().append("g").attr("transform",function(t){return"root"===t.id?"translate(".concat(t.x0,",").concat(t.y0,")"):"translate(".concat(a(t.x0),",").concat(i(t.y0),")")});o.append("title").text(function(t){return t.data.categoryName}),o.append("rect").attr("id",function(t){return t.id}).attr("width",function(t){return console.log(t),"root"===t.id?t.x1-t.x0:a(t.x1)-a(t.x0)}).attr("height",function(t){return"root"===t.id?t.y1-t.y0:i(t.y1)-i(t.y0)}).attr("fill",function(){return"#bada55"}),o.select("rect").attr("cursor","pointer").on("click",function(e){r._zoomTo(e,t)}),o.enter().append("clipPath").attr("id",function(t){return"clip-"+t.id}).append("use").attr("xlink:href",function(t){return"#"+t.id});var c=o.append("text").attr("id",function(t){return"text-"+t.id}).attr("clip-path",function(t){return"url(#clip-"+t.id+")"});return c.attr("x",4).attr("y",13).text(function(t){return t.data.categoryName}),this._wrap(c,d3),c.attr("opacity",function(){var t=this.parentNode.getBoundingClientRect().width,e=d3.select(this.parentNode).select("rect").node().getBoundingClientRect().width,r=this.parentNode.getBoundingClientRect().height,a=d3.select(this.parentNode).select("rect").node().getBoundingClientRect().height,i=n.map(function(t){return{display:t.categoryName,value:t.categorySize}});return _tooltip.default.bindTooltip(o,i,d3,d3.format("$,d")),t>e||r>a?0:1}),t.select(".parent")}},{key:"_wrap",value:function(t){t.each(function(){for(var t=d3.select(this.parentNode).select("rect").node().getBoundingClientRect().width-8,e=d3.select(this),r=e.text().split(/\s+/).reverse(),n=r.pop(),a=[],i=e.attr("y"),o=e.text(null).append("tspan").attr("x",4).attr("y",i).attr("dy","0em"),c=0;null!=n;){a.push(n),o.text(a.join(" ")),o.node().getBoundingClientRect().width>t&&(c+=1,a.pop(),o.text(a.join(" ")),a=[n],o=e.append("tspan").attr("x",4).attr("y",i).attr("dy",1.1*c+0+"em").text(n)),n=r.pop()}})}},{key:"_zoomTo",value:function(t,e){if(t.id!==this.root.id){var r=t;for(console.log(r);null!=this.root.parent&&null!=r.parent&&r.parent.id!==this.root.parent.id;)r=r.parent;console.log(r),this._transition(e,r,e.select(".parent"))}}},{key:"_transition",value:function(t,e,r){var n=this;if(!this.transitioning&&e){this.transitioning=!0;var a=d3.transition().attrTween("opacity",function(){return d3.interpolateNumber(0,1)}).duration(3e3),i=d3.transition().attrTween("opacity",function(){return console.log("calling tween"),d3.interpolateNumber(1,0)}).duration(3e3).on("end",function(){n.transitioning=!1}),o=this._render(t,e,0);o.attr("opacity",0).style("fill-opacity",0),r.transition(i).remove().each(function(){n.transitioning=!1}),o.transition(a)}}}]),t}();exports.default=TreeMap;