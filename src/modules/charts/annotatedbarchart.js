"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_numberFormat=require("../utilities/numberFormat"),AnnotatedBarChart=function t(e){function n(t){return t.y2>0?12:-2}function a(t){return t.y2>0?12:4}(0,_classCallCheck2.default)(this,t),console.log(e);var r,o=JSON.parse(JSON.stringify(e)),i=o.sheets.data,l=o.sheets.template,c=o.sheets.labels,s=Math.max(document.documentElement.clientWidth,window.innerWidth||0),u=s<610,d=document.querySelector("#graphicContainer").getBoundingClientRect().width,f=.5*d;r=l[0]["margin-top"]?{top:+l[0]["margin-top"],right:+l[0]["margin-right"],bottom:+l[0]["margin-bottom"],left:+l[0]["margin-left"]}:{top:0,right:0,bottom:20,left:40},d=d-r.left-r.right,f=f-r.top-r.bottom,d3.select("#chartTitle").text(l[0].title),d3.select("#subTitle").text(l[0].subtitle),d3.select("#sourceText").html(l[0].source),d3.select("#footnote").html(l[0].footnote),d3.select("#graphicContainer svg").remove(),d3.select("#chartKey").html("");var p,h=d3.select("#graphicContainer").append("svg").attr("width",d+r.left+r.right).attr("height",f+r.top+r.bottom).attr("id","svg").attr("overflow","hidden"),m=h.append("g").attr("transform","translate("+r.left+","+r.top+")"),x=Object.keys(i[0]);l[0].xColumn?(p=l[0].xColumn,x.splice(x.indexOf(p),1)):(p=x[0],x.splice(0,1)),console.log(p,x),i.forEach(function(t){"string"==typeof t[p]&&(t[p]=+t[p]),x.forEach(function(e){t[e]=+t[e]})}),c.forEach(function(t){t.x=+t.x,t.y=+t.y,t.y2=+t.y2}),console.log(c);var g=d3.scaleBand().range([0,d]).paddingInner(.08),b=d3.scaleLinear().range([f,0]);g.domain(i.map(function(t){return t[p]})),b.domain(d3.extent(i,function(t){return t[x[0]]})).nice();var y,C,F=g.domain().filter(function(t,e){return!(e%10)});u&&(F=g.domain().filter(function(t,e){return!(e%20)})),u?(y=d3.axisBottom(g).tickValues(F),C=d3.axisLeft(b).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)}).ticks(5)):(y=d3.axisBottom(g).tickValues(F),C=d3.axisLeft(b).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)})),m.append("g").attr("class","x").attr("transform","translate(0,"+f+")").call(y),m.append("g").attr("class","y").call(C),m.selectAll(".bar").data(i).enter().append("rect").attr("class","bar").attr("x",function(t){return g(t[p])}).style("fill",function(){return"rgb(204, 10, 17)"}).attr("y",function(t){return b(Math.max(t[x[0]],0))}).attr("width",g.bandwidth()).attr("height",function(t){return Math.abs(b(t[x[0]])-b(0))}),m.selectAll(".annotationLine").data(c).enter().append("line").attr("class","annotationLine").attr("x1",function(t){return g(t.x)+g.bandwidth()/2}).attr("y1",function(t){return b(t.y)}).attr("x2",function(t){return g(t.x)+g.bandwidth()/2}).attr("y2",function(t){return b(t.y2)}).style("opacity",1).attr("stroke","#000");var v=d3.select("#footerAnnotations");v.html(""),u?(m.selectAll(".annotationCircles").data(c).enter().append("circle").attr("class","annotationCircle").attr("cy",function(t){return b(t.y2)+n(t)/2}).attr("cx",function(t){return g(t.x)+g.bandwidth()/2}).attr("r",8).attr("fill","#000"),m.selectAll(".annotationTextMobile").data(c).enter().append("text").attr("class","annotationTextMobile").attr("y",function(t){return b(t.y2)+a(t)}).attr("x",function(t){return g(t.x)+g.bandwidth()/2}).style("text-anchor","middle").style("opacity",1).attr("fill","#FFF").text(function(t,e){return e+1}),console.log(c.length),c.length>0&&v.append("span").attr("class","annotationFooterHeader").text("Notes: "),c.forEach(function(t,e){v.append("span").attr("class","annotationFooterNumber").text(e+1+" - "),e<c.length-1?v.append("span").attr("class","annotationFooterText").text(t.text+", "):v.append("span").attr("class","annotationFooterText").text(t.text)})):m.selectAll(".annotationText").data(c).enter().append("text").attr("class","annotationText").attr("y",function(t){return b(t.y2)}).attr("x",function(t){return g(t.x)+g.bandwidth()/2}).style("text-anchor",function(t){return t.align}).style("opacity",1).text(function(t){return t.text})};exports.default=AnnotatedBarChart;