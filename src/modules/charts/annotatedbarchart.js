"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_numberFormat=require("../utilities/numberFormat"),AnnotatedBarChart=function t(e){function n(t){return t.y2>0?12:-2}function a(t){return t.y2>0?12:4}(0,_classCallCheck2.default)(this,t),console.log(e);var r,o=e.sheets.data,i=e.sheets.details,l=e.sheets.labels,c=Math.max(document.documentElement.clientWidth,window.innerWidth||0),s=c<610,u=document.querySelector("#graphicContainer").getBoundingClientRect().width,d=.5*u;r=i[0]["margin-top"]?{top:+i[0]["margin-top"],right:+i[0]["margin-right"],bottom:+i[0]["margin-bottom"],left:+i[0]["margin-left"]}:{top:0,right:0,bottom:20,left:40},u=u-r.left-r.right,d=d-r.top-r.bottom,d3.select("#chartTitle").text(i[0].title),d3.select("#subTitle").text(i[0].subtitle),d3.select("#sourceText").html(i[0].source),d3.select("#footnote").html(i[0].footnote),d3.select("#graphicContainer svg").remove(),d3.select("#chartKey").html("");var f,p=d3.select("#graphicContainer").append("svg").attr("width",u+r.left+r.right).attr("height",d+r.top+r.bottom).attr("id","svg").attr("overflow","hidden"),h=p.append("g").attr("transform","translate("+r.left+","+r.top+")"),m=Object.keys(o[0]);i[0].xColumn?(f=i[0].xColumn,m.splice(m.indexOf(f),1)):(f=m[0],m.splice(0,1)),console.log(f,m),o.forEach(function(t){"string"==typeof t[f]&&(t[f]=+t[f]),m.forEach(function(e){t[e]=+t[e]})}),l.forEach(function(t){t.x=+t.x,t.y=+t.y,t.y2=+t.y2}),console.log(l);var x=d3.scaleBand().range([0,u]).paddingInner(.08),g=d3.scaleLinear().range([d,0]);x.domain(o.map(function(t){return t[f]})),g.domain(d3.extent(o,function(t){return t[m[0]]})).nice();var b,y,C=x.domain().filter(function(t,e){return!(e%10)});s&&(C=x.domain().filter(function(t,e){return!(e%20)})),s?(b=d3.axisBottom(x).tickValues(C),y=d3.axisLeft(g).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)}).ticks(5)):(b=d3.axisBottom(x).tickValues(C),y=d3.axisLeft(g).tickFormat(function(t){return(0,_numberFormat.numberFormat)(t)})),h.append("g").attr("class","x").attr("transform","translate(0,"+d+")").call(b),h.append("g").attr("class","y").call(y),h.selectAll(".bar").data(o).enter().append("rect").attr("class","bar").attr("x",function(t){return x(t[f])}).style("fill",function(){return"rgb(204, 10, 17)"}).attr("y",function(t){return g(Math.max(t[m[0]],0))}).attr("width",x.bandwidth()).attr("height",function(t){return Math.abs(g(t[m[0]])-g(0))}),h.selectAll(".annotationLine").data(l).enter().append("line").attr("class","annotationLine").attr("x1",function(t){return x(t.x)+x.bandwidth()/2}).attr("y1",function(t){return g(t.y)}).attr("x2",function(t){return x(t.x)+x.bandwidth()/2}).attr("y2",function(t){return g(t.y2)}).style("opacity",1).attr("stroke","#000");var F=d3.select("#footerAnnotations");F.html(""),s?(h.selectAll(".annotationCircles").data(l).enter().append("circle").attr("class","annotationCircle").attr("cy",function(t){return g(t.y2)+n(t)/2}).attr("cx",function(t){return x(t.x)+x.bandwidth()/2}).attr("r",8).attr("fill","#000"),h.selectAll(".annotationTextMobile").data(l).enter().append("text").attr("class","annotationTextMobile").attr("y",function(t){return g(t.y2)+a(t)}).attr("x",function(t){return x(t.x)+x.bandwidth()/2}).style("text-anchor","middle").style("opacity",1).attr("fill","#FFF").text(function(t,e){return e+1}),console.log(l.length),l.length>0&&F.append("span").attr("class","annotationFooterHeader").text("Notes: "),l.forEach(function(t,e){F.append("span").attr("class","annotationFooterNumber").text(e+1+" - "),e<l.length-1?F.append("span").attr("class","annotationFooterText").text(t.text+", "):F.append("span").attr("class","annotationFooterText").text(t.text)})):h.selectAll(".annotationText").data(l).enter().append("text").attr("class","annotationText").attr("y",function(t){return g(t.y2)}).attr("x",function(t){return x(t.x)+x.bandwidth()/2}).style("text-anchor",function(t){return t.align}).style("opacity",1).text(function(t){return t.text})};exports.default=AnnotatedBarChart;